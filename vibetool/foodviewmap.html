<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åº—å®¶è¿½è¹¤åœ°åœ–</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Microsoft JhengHei',Arial,sans-serif;background:#f5f5f5;}
    #map{height:70vh;width:100%;}
    .controls{background:white;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);
      display:flex;gap:15px;align-items:center;flex-wrap:wrap;}
    button{background:#4CAF50;color:white;border:none;padding:12px 24px;border-radius:5px;
      cursor:pointer;font-size:16px;transition:all 0.3s;}
    button:hover{background:#45a049;transform:translateY(-2px);}
    button:disabled{background:#ccc;cursor:not-allowed;}
    #addressSearch{flex:1;min-width:200px;padding:12px;border:2px solid #ddd;border-radius:5px;font-size:16px;}
    .stats{background:white;padding:15px 20px;display:flex;gap:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .stat-item{display:flex;flex-direction:column;align-items:center;}
    .stat-value{font-size:32px;font-weight:bold;color:#4CAF50;}
    .stat-label{font-size:14px;color:#666;margin-top:5px;}
    #messages{position:fixed;top:20px;right:20px;z-index:1000;max-width:400px;}
    #messages>div{padding:15px 20px;margin-bottom:10px;border-radius:5px;
      box-shadow:0 2px 10px rgba(0,0,0,0.2);animation:slideIn 0.3s ease;}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
    .success{background:#4CAF50;color:white;}
    .error{background:#f44336;color:white;}
    .info{background:#2196F3;color:white;}
    .info-window{max-width:300px;padding:10px;}
    .info-window h3{margin-bottom:10px;color:#333;}
    .info-window p{margin:5px 0;color:#666;font-size:14px;}
    .remove-btn{width:100%;margin-top:10px;background:#4CAF50;color:white;border:none;
      padding:10px;border-radius:5px;cursor:pointer;font-size:14px;}
    .remove-btn:hover{background:#45a049;}
  </style>
</head>
<body>
  <div class="stats">
    <div class="stat-item"><div class="stat-value" id="totalStores">0</div><div class="stat-label">ç¸½åº—å®¶æ•¸</div></div>
    <div class="stat-item"><div class="stat-value" id="visitedTotal">0</div><div class="stat-label">å·²æ‹œè¨ª</div></div>
    <div class="stat-item"><div class="stat-value" id="activeMarkers">0</div><div class="stat-label">å¾…æ‹œè¨ª</div></div>
  </div>

  <div class="controls">
    <button id="loadData" onclick="loadStoreData()">ğŸ“¥ è¼‰å…¥åº—å®¶è³‡æ–™</button>
    <input type="text" id="addressSearch" placeholder="è¼¸å…¥åœ°å€æˆ–å€åŸŸåç¨±ï¼ˆä¾‹ï¼šå°åŒ—ã€å¤§å®‰å€ï¼‰" />
    <button onclick="searchAndMoveMap()">ğŸ” æœå°‹ä½ç½®</button>
  </div>

  <div id="map"></div>
  <div id="messages"></div>
<script>
/**********************
 *  å…¨åŸŸè¨­å®šå€
 **********************/
const BASE_API_URL = 'https://script.google.com/macros/s/AKfycbyXe1tkQjcRMaWE-MqYIQmpzL764lcqKSJXfx96kHNYlLE1MyTVA84WnZHfZ_HRhrfz/exec';
const APP_VERSION = '1.0.0';
const SHARED_KEY = 'frontend-v3.1';
const DRAW_ONLY_UNVISITED = true;
const MAP_KEY_URL = 'https://jeanyuliya.zeabur.app/webhook/get-map-key?token=frontend-v3.1';

let map, markers = [], storeData = [];

/**********************
 *  ç”Ÿæˆ API URL
 **********************/
const DATA_URL = () => `${BASE_API_URL}?action=read&onlyUnvisited=${DRAW_ONLY_UNVISITED?'true':'false'}&appVersion=${APP_VERSION}`;
async function UPDATE_URL(rowIndex, name){
  const ts = Date.now();
  const sig = await makeSignature(ts, SHARED_KEY);
  return `${BASE_API_URL}?action=markVisited&rowIndex=${rowIndex}&storeName=${encodeURIComponent(name)}&ts=${ts}&sig=${sig}&appVersion=${APP_VERSION}`;
}

/**********************
 *  ç”¢ç”Ÿç°½ç« 
 **********************/
async function makeSignature(ts, secret) {
  const enc = new TextEncoder();
  const key = await crypto.subtle.importKey("raw", enc.encode(secret),
    { name:"HMAC", hash:"SHA-256" }, false, ["sign"]);
  const sig = await crypto.subtle.sign("HMAC", key, enc.encode(String(ts)));
  return btoa(String.fromCharCode(...new Uint8Array(sig)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

/**********************
 *  å®¹éŒ¯ Fetchï¼ˆCORS ä»£ç†ï¼‰
 **********************/
async function fetchWithFallback(url) {
  const proxies = [
    (u) => fetch(u),
    (u) => fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(u)),
    (u) => fetch('https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u))
  ];
  for (const fn of proxies) {
    try {
      const res = await fn(url);
      if (res.ok) return res;
    } catch {}
  }
  throw new Error('æ‰€æœ‰é€šé“çš†å¤±æ•—');
}

/**********************
 *  å¾ n8n å– Google Maps Key
 **********************/
async function getMapApiKey() {
  const res = await fetch(MAP_KEY_URL);
  const json = await res.json();
  if (!json.success) throw new Error(json.message || 'Failed to fetch key');
  return json.apiKey;
}

/**********************
 *  è¼‰å…¥ Google Maps
 **********************/
async function loadGoogleMapsAPI() {
  try {
    const key = await getMapApiKey();
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap&v=weekly`;
    script.async = true;
    script.defer = true;
    script.onerror = () => showMessage('åœ°åœ– API è¼‰å…¥å¤±æ•—', 'error');
    document.head.appendChild(script);
  } catch (e) {
    console.error('Maps Key å–å¾—å¤±æ•—:', e);
    showMessage('ç„¡æ³•å¾ä¼ºæœç«¯å–å¾— Maps Key', 'error');
  }
}

/**********************
 *  åœ°åœ–åˆå§‹åŒ–
 **********************/
function initMap() {
  const center = { lat: 25.0330, lng: 121.5654 };
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 12,
    center
  });
  showMessage('åœ°åœ–åˆå§‹åŒ–å®Œæˆ', 'success');
  loadStoreData();
}

/**********************
 *  å¾ GAS è¼‰å…¥è³‡æ–™ï¼ˆåŒæ™‚çµ±è¨ˆå…¨æ•¸ï¼Œä½†åœ°åœ–åªç•«æœªæ‹œè¨ªï¼‰
 **********************/
async function loadStoreData() {
  const btn = document.getElementById('loadData');
  btn.disabled = true;
  btn.textContent = 'è¼‰å…¥ä¸­â€¦';
  showMessage('å¾ Google Sheets è¼‰å…¥è³‡æ–™ä¸­â€¦', 'info');

  try {
    const res = await fetchWithFallback(DATA_URL());
    const json = await res.json();
    if (!json.success) throw new Error(json.message || 'è³‡æ–™è¼‰å…¥å¤±æ•—');

    // âœ… å…¨éƒ¨è³‡æ–™
    const allData = (json.data || []).map(s => ({
      rowIndex: s.rowIndex,
      name: s['é¤å»³æˆ–æ™¯é»'] || s.name || 'æœªå‘½å',
      category: s['é¡åˆ¥'] || '',
      focus: s['é—œæ³¨é‡é»'] || '',
      address: s['åœ°å€'] || '',
      description: s['å‚™è¨»'] || '',
      lat: parseFloat(s['ç·¯åº¦'] || s.lat || 0),
      lng: parseFloat(s['ç¶“åº¦'] || s.lng || 0),
      completed: ['æ˜¯', 'true', '1', 'âœ“', 'checked'].includes(String(s['å®Œæˆ']).toLowerCase())
    }));

    // âœ… çµ±è¨ˆæ‰€æœ‰è³‡æ–™
    const visited = allData.filter(s => s.completed).length;
    const total = allData.length;
    const unvisited = total - visited;

    // âœ… åœ°åœ–åªé¡¯ç¤ºã€Œæœªæ‹œè¨ªã€çš„åº—å®¶
    storeData = allData.filter(s => !s.completed);
    createMarkers();

    // âœ… æ›´æ–° UI çµ±è¨ˆæ•¸å­—ï¼ˆå…¨éƒ¨çµ±è¨ˆï¼‰
    document.getElementById('totalStores').textContent = total;
    document.getElementById('visitedTotal').textContent = visited;
    document.getElementById('activeMarkers').textContent = unvisited;

    showMessage(`æˆåŠŸè¼‰å…¥ ${total} ç­†è³‡æ–™ï¼ˆæœªæ‹œè¨ª ${unvisited} ç­†ï¼‰`, 'success');

  } catch (e) {
    showMessage(`è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š${e.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ“¥ è¼‰å…¥åº—å®¶è³‡æ–™';
  }
}


/**********************
 *  ç”¢ç”Ÿæ¨™è¨˜èˆ‡è³‡è¨Šçª—
 **********************/
function createMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];

  storeData.forEach((s, i) => {
    if (s.completed) return;
    if (!s.lat || !s.lng) return;

    const marker = new google.maps.Marker({
      map,
      position: { lat: s.lat, lng: s.lng },
      title: s.name,
      icon: {
        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
        scaledSize: new google.maps.Size(40, 40)
      }
    });

    const info = new google.maps.InfoWindow({
      content: `
        <div class="info-window">
          <h3>${s.name}</h3>
          <p><strong>é¡åˆ¥ï¼š</strong>${s.category || 'ç„¡'}</p>
          <p><strong>é—œæ³¨é‡é»ï¼š</strong>${s.focus || 'ç„¡'}</p>
          <p><strong>åœ°å€ï¼š</strong>${s.address || 'ç„¡'}</p>
          <p><strong>å‚™è¨»ï¼š</strong>${s.description || 'ç„¡'}</p>
          <button class="remove-btn" onclick="removeMarker(${i})">âœ… æ¨™è¨˜ç‚ºå·²æ‹œè¨ª</button>
        </div>`
    });

    marker.addListener('click', () => {
      markers.forEach(m => m.infoWindow?.close());
      info.open(map, marker);
    });

    marker.infoWindow = info;
    marker.storeIndex = i;
    marker.rowIndex = s.rowIndex;
    markers.push(marker);
  });

  document.getElementById('activeMarkers').textContent = markers.length;
}

/**********************
 *  æ¨™è¨˜ç‚ºå·²æ‹œè¨ª
 **********************/
async function removeMarker(idx) {
  const marker = markers.find(x => x.storeIndex === idx);
  const s = storeData[idx];
  if (!marker || !s) return showMessage('æ‰¾ä¸åˆ°æ¨™è¨˜', 'error');

  try {
    showMessage('æ›´æ–°ä¸­â€¦', 'info');
    const url = await UPDATE_URL(s.rowIndex, s.name);
    const res = await fetchWithFallback(url);
    const j = await res.json();
    if (!j.success) throw new Error(j.message);

    marker.setMap(null);
    document.getElementById('visitedTotal').textContent =
      parseInt(document.getElementById('visitedTotal').textContent) + 1;
    document.getElementById('activeMarkers').textContent =
      parseInt(document.getElementById('activeMarkers').textContent) - 1;

    showMessage(`ã€Œ${s.name}ã€å·²æ¨™è¨˜ç‚ºå·²æ‹œè¨ª`, 'success');
  } catch (e) {
    showMessage(`æ¨™è¨˜å¤±æ•—ï¼š${e.message}`, 'error');
  }
}

/**********************
 *  æœå°‹åŠŸèƒ½
 **********************/
async function searchAndMoveMap() {
  const q = document.getElementById('addressSearch').value.trim();
  if (!q) return showMessage('è«‹è¼¸å…¥åœ°é»', 'error');
  const g = new google.maps.Geocoder();
  g.geocode({ address: q + ' å°ç£', region: 'TW' }, (r, s) => {
    if (s === 'OK' && r[0]) {
      const loc = r[0].geometry.location;
      map.setCenter(loc); map.setZoom(15);
      new google.maps.Marker({
        map,
        position: loc,
        icon: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
      });
      showMessage(`ç§»å‹•åˆ° ${r[0].formatted_address}`, 'success');
    } else showMessage('æ‰¾ä¸åˆ°æŒ‡å®šåœ°é»', 'error');
  });
}

/**********************
 *  è¨Šæ¯é¡¯ç¤º
 **********************/
function showMessage(msg, type='info') {
  const box = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = type;
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

window.addEventListener('load',()=>{loadGoogleMapsAPI();});
</script>
</body>
</html>
