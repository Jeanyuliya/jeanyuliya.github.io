<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åº—å®¶è¿½è¹¤åœ°åœ–</title>
  <style>
    /* çµ±ä¸€å­—é«”ç‚ºç¹é«”ä¸­æ–‡å‹å–„å­—é«” */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Microsoft JhengHei', 'Inter', Arial, sans-serif; background: #f5f5f5; }
    #map { height: 70vh; width: 100%; border-radius: 8px; overflow: hidden; }
    .controls {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px; /* çµ±ä¸€ä½¿ç”¨åœ“è§’ */
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      box-shadow: 0 4px #388E3C; /* æ·»åŠ ç«‹é«”æ„Ÿ */
    }
    button:hover { 
      background: #45a049; 
      transform: translateY(-2px); 
      box-shadow: 0 6px #388E3C; 
    }
    button:active {
      transform: translateY(2px);
      box-shadow: 0 2px #388E3C;
    }
    button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
    #addressSearch {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    .stats {
      background: white;
      padding: 15px 20px;
      display: flex;
      gap: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 0 0 8px 8px;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #4CAF50;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    #messages {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }
    #messages > div {
      padding: 15px 20px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
      /* ç¢ºä¿è¨Šæ¯æ¡†åœ¨å°è¢å¹•ä¸‹ä¸æœƒæº¢å‡º */
      word-wrap: break-word;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .success { background: #4CAF50; color: white; }
    .error { background: #f44336; color: white; }
    .info { background: #2196F3; color: white; }
    .info-window {
      max-width: 300px;
      padding: 10px;
    }
    .info-window h3 {
      margin-bottom: 10px;
      color: #333;
    }
    .info-window p {
      margin: 5px 0;
      color: #666;
      font-size: 14px;
    }
    .remove-btn {
      width: 100%;
      margin-top: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .remove-btn:hover { background: #45a049; }

    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: stretch; }
      .stats { gap: 15px; justify-content: space-around; }
      .stat-value { font-size: 24px; }
      #addressSearch { min-width: 100%; }
      button { width: 100%; }
      #messages { right: 10px; left: 10px; top: 10px; max-width: none; }
    }
  </style>
</head>
<body>
  <div class="stats">
    <div class="stat-item">
      <div class="stat-value" id="totalStores">0</div>
      <div class="stat-label">ç¸½åº—å®¶æ•¸</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="visitedTotal">0</div>
      <div class="stat-label">å·²æ‹œè¨ª</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="activeMarkers">0</div>
      <div class="stat-label">å¾…æ‹œè¨ª</div>
    </div>
  </div>

  <div class="controls">
    <button id="loadData" onclick="loadStoreData()">ğŸ“¥ è¼‰å…¥åº—å®¶è³‡æ–™</button>
    <input type="text" id="addressSearch" placeholder="è¼¸å…¥åœ°å€æˆ–å€åŸŸåç¨±ï¼ˆä¾‹ï¼šå°åŒ—ã€å¤§å®‰å€ï¼‰">
    <button onclick="searchAndMoveMap()">ğŸ” æœå°‹ä½ç½®</button>
  </div>

  <div id="map"></div>
  <div id="messages"></div>

  <script>
    /**********************
     * å¯èª¿åƒæ•¸å€
     **********************/

    // âœ… Google Apps Script Web App URL (ç”¨æ–¼è®€å–/å¯«å…¥)
    // ğŸš¨ è«‹è²¼ä¸Šæ‚¨åˆä½µå°ˆæ¡ˆå¾Œã€Œé‡æ–°éƒ¨ç½²ã€çš„ Web App URL
    const BASE_API_URL = 'https://script.google.com/macros/s/AKfycbyXe1tkQjcRMaWE-MqYIQmpzL764lcqKSJXfx96kHNYlLE1MyTVA84WnZHfZ_HRhrfz/exec'; 

    // âœ… Google Maps Keyï¼ˆå¯ç•™ç©ºï¼‰
    const GOOGLE_MAPS_KEY = '';

    // âœ… åœ°åœ–åªç•«æœªæ‹œè¨ª
    const DRAW_ONLY_UNVISITED = true;

    /**********************
     * å…§éƒ¨è®Šæ•¸
     **********************/
    let map;
    let markers = [];
    let storeData = [];
    let removedStores = new Set();
    let infoWindow = null; 

    // CORS æ–¹æ¡ˆ (ç”¨æ–¼ GET è®€å–)
    const CORS_INVOCATIONS = [
      (url) => fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url)),
      (url) => fetch('https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url)),
      (url) => fetch('https://cors.isomorphic-git.org/' + url),
    ];

    // URL builders (è®€å¯«éƒ½ä¸éœ€è¦ Token)
    const DATA_URL = () => `${BASE_API_URL}?onlyUnvisited=${DRAW_ONLY_UNVISITED?'true':'false'}&t=${Date.now()}`;
    const TOTALS_URL = () => `${BASE_API_URL}?t=${Date.now()}`;

    /**********************
     * åœ°åœ–åˆå§‹åŒ–
     **********************/
    function initMap() {
      try {
        const defaultCenter = { lat: 25.0330, lng: 121.5654 };
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: defaultCenter,
          mapTypeId: 'roadmap',
          styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
        });
        infoWindow = new google.maps.InfoWindow();
        showMessage('åœ°åœ–åˆå§‹åŒ–å®Œæˆï¼é»æ“Šã€Œè¼‰å…¥åº—å®¶è³‡æ–™ã€é–‹å§‹ä½¿ç”¨', 'success');
      } catch (err) {
        console.error('åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤:', err);
        showMessage('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š', 'error');
      }
    }

    function loadGoogleMapsAPI() {
      const script = document.createElement('script');
      const keyPart = GOOGLE_MAPS_KEY ? `&key=${GOOGLE_MAPS_KEY}` : '';
      script.src = `https://maps.googleapis.com/maps/api/js?v=weekly&callback=initMap${keyPart}`;
      script.async = true;
      script.defer = true;
      script.onerror = () => showMessage('åœ°åœ– API è¼‰å…¥å¤±æ•—', 'error');
      document.head.appendChild(script);
    }

    /**********************
     * æŠ“è³‡æ–™ + çµ±è¨ˆ (GET è®€å–)
     **********************/
    async function fetchWithFallback(url) {
      // å˜—è©¦ç›´æ¥è®€å–
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res;
      } catch (e) {
        // å¦‚æœç›´æ¥è®€å–å¤±æ•—ï¼Œæ‰å˜—è©¦ CORS ä»£ç†
        console.warn('ç›´æ¥è®€å–å¤±æ•—ï¼Œå˜—è©¦ CORS ä»£ç†...', e);
        let lastErr;
        for (const call of CORS_INVOCATIONS) {
          try {
            const res = await call(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res;
          } catch (e) {
            lastErr = e;
          }
        }
        throw lastErr || new Error('æ‰€æœ‰é€šé“çš†å¤±æ•—');
      }
    }

    async function loadStoreData() {
      const btn = document.getElementById('loadData');
      btn.disabled = true;
      btn.textContent = 'è¼‰å…¥ä¸­â€¦';
      clearMarkers();
      removedStores.clear();
      showMessage('æ­£åœ¨å¾ Google Sheets è¼‰å…¥è³‡æ–™â€¦', 'info');

      try {
        // è®€å–è«‹æ±‚ä¸å†éœ€è¦ Token
        const res1 = await fetchWithFallback(DATA_URL());
        const text1 = await res1.text();
        const dataResponse = JSON.parse(text1);

        if (!dataResponse.success) {
          // é€™è£¡æœƒæ•ç²éŒ¯èª¤
          throw new Error(dataResponse.message || 'è³‡æ–™è®€å–å¤±æ•—');
        }
        
        // ç¢ºä¿ data æ¬„ä½å­˜åœ¨
        if (!Array.isArray(dataResponse.data)) {
            throw new Error('GAS ä¼ºæœå™¨å›å‚³çš„è³‡æ–™çµæ§‹éŒ¯èª¤ (ç¼ºå°‘ data é™£åˆ—)');
        }

        // åƒ…ä¿ç•™æœ‰ç¶“ç·¯åº¦çš„æœ‰æ•ˆåº—å®¶
        storeData = dataResponse.data.filter(s => s.lat && s.lng && s.name); 

        // è®€å–çµ±è¨ˆæ•¸æ“š
        let totals = dataResponse.meta || { total: storeData.length, visited: 0, unvisited: storeData.length };
        
        // ç‚ºäº†ç¢ºä¿çµ±è¨ˆæ•¸å­—æº–ç¢ºï¼Œå¯èƒ½éœ€è¦é¡å¤–å‘¼å«ä¸€æ¬¡ GAS å–å¾—å®Œæ•´çš„ totals (å¦‚æœ GAS æ²’åœ¨ç¬¬ä¸€æ¬¡å›å‚³å®Œæ•´çš„è©±)
        if (!dataResponse.meta || totals.total === 0) {
            const fullRes = await fetchWithFallback(TOTALS_URL());
            const fullText = await fullRes.text();
            const fullDataResponse = JSON.parse(fullText);
            totals = fullDataResponse.meta || totals;
        }

        createMarkers();
        applyTotalsToUI(totals);
        showMessage(`æˆåŠŸè¼‰å…¥ ${storeData.length} ç­†å¾…æ‹œè¨ªåº—å®¶è³‡æ–™ (ç¸½è¨ˆ ${totals.total} ç­†)`, 'success');
        updateActiveMarkersUI();

      } catch (err) {
        console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', err);
        // å¦‚æœæ˜¯ CORS éŒ¯èª¤ï¼Œé€šå¸¸æ˜¯ Failed to fetchï¼Œæç¤ºä½¿ç”¨è€…æª¢æŸ¥éƒ¨ç½²è¨­å®š
        showMessage(`è¼‰å…¥å¤±æ•—ï¼š${err.message || err} (è«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦ç‚ºã€Œä»»ä½•äººã€)`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“¥ è¼‰å…¥åº—å®¶è³‡æ–™';
      }
    }

    function applyTotalsToUI(totals) {
      document.getElementById('totalStores').textContent = totals.total;
      document.getElementById('visitedTotal').textContent = totals.visited;
      document.getElementById('activeMarkers').textContent = markers.length;
    }

    /**********************
     * ç¹ªè£½æ¨™è¨˜
     **********************/
    function clearMarkers() {
      markers.forEach(m => { try { m.setMap(null) } catch {} });
      markers.length = 0;
    }

    function createMarkers() {
      clearMarkers();
      storeData.forEach((store, index) => {
        // å‡è¨­ GAS å·²ç¶“éæ¿¾æ‰å·²æ‹œè¨ªï¼Œä½†ç‚ºäº†å‰ç«¯å®‰å…¨æª¢æŸ¥
        if (store.completed) return; 
        
        const lat = parseFloat(store.lat), lng = parseFloat(store.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const marker = new google.maps.Marker({
          map,
          position: {lat, lng},
          title: store.name || 'æœªçŸ¥åº—å®¶',
          icon: {
            // ä½¿ç”¨ç¶ è‰²åœ–æ¨™è¡¨ç¤ºå¾…è¾¦
            url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
            scaledSize: new google.maps.Size(40, 40)
          }
        });

        marker.storeData = store;
        marker.storeIndex = index;

        marker.addListener('click', () => {
          if (infoWindow) infoWindow.close(); 
          
          const content = `
            <div class="info-window">
              <h3>${store.name || 'æœªçŸ¥åº—å®¶'}</h3>
              <p><strong>é¡åˆ¥:</strong> ${store.category || 'æœªåˆ†é¡'}</p>
              <p><strong>é—œæ³¨é‡é»:</strong> ${store.focus || 'ç„¡'}</p>
              <p><strong>åœ°å€:</strong> ${store.address || 'ç„¡åœ°å€è³‡è¨Š'}</p>
              <p><strong>å‚™è¨»:</strong> ${store.description || 'ç„¡å‚™è¨»'}</p>
              <p><strong>ç´€éŒ„æ™‚é–“:</strong> ${store.recordTime || 'ç„¡ç´€éŒ„'}</p>
              <button class="remove-btn" onclick="removeMarker(${index})">âœ… æ¨™è¨˜ç‚ºå·²æ‹œè¨ª</button>
            </div>`;
            
          infoWindow.setContent(content);
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });

      if (markers.length) {
        const bounds = new google.maps.LatLngBounds();
        markers.forEach(m => bounds.extend(m.getPosition()));
        map.fitBounds(bounds);
      }
      updateActiveMarkersUI();
    }

    function updateActiveMarkersUI() {
      document.getElementById('activeMarkers').textContent = markers.length;
    }

    /**********************
     * æ¨™è¨˜ç‚ºå·²æ‹œè¨ª (POST å¯«å…¥ - ç„¡ Token)
     **********************/
    async function markAsVisitedInSheet(rowIndex, storeName) {
      // å¯«å…¥ä¸éœ€è¦ Tokenï¼Œç›´æ¥ç™¼é€è«‹æ±‚
      const targetUrl = BASE_API_URL;
      
      const payload = {
        action: 'markVisited',
        rowIndex: rowIndex,
        storeName: storeName
      };

      try {
        const res = await fetch(targetUrl, {
          method: 'POST',
          // âš ï¸ Apps Script çš„ doPost(e) æœƒé€éæª¢æŸ¥ Content-Type: application/json
          //    ä¾†æä¾›ä¸€å®šç¨‹åº¦çš„ CSRF ä¿è­· (é˜»æ­¢ç°¡å–®çš„è¡¨å–®æäº¤æ”»æ“Š)
          headers: {
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
          throw new Error(`HTTP éŒ¯èª¤: ${res.status} (è«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æ˜¯å¦ç‚ºã€Œä»»ä½•äººã€)`);
        }

        const json = await res.json();
        if (!json || json.success !== true) {
          throw new Error(json?.message || json?.error || 'æ›´æ–° Google Sheets å¤±æ•—ï¼Œè«‹æª¢æŸ¥ doPost(e) å‡½å¼åŸ·è¡Œçµæœ');
        }
        return json;
      } catch (e) {
          throw e;
      }
    }

    async function removeMarker(storeIndex) {
      const marker = markers.find(m => m.storeIndex === storeIndex);
      const store = storeData[storeIndex];
      
      if (!marker || !store) {
        showMessage('æ‰¾ä¸åˆ°è¦ç§»é™¤çš„æ¨™è¨˜', 'error');
        return;
      }
      
      if (infoWindow) infoWindow.close();

      try {
        showMessage(`æ­£åœ¨æ¨™è¨˜ã€Œ${store.name}ã€ç‚ºå·²å®Œæˆâ€¦`, 'info');
        
        // ç¢ºä¿ store.rowIndex æ˜¯æ­£ç¢ºçš„ Sheets è¡Œè™Ÿ
        await markAsVisitedInSheet(store.rowIndex, store.name);

        marker.setMap(null);
        markers = markers.filter(m => m !== marker);

        storeData[storeIndex].completed = true;
        
        const visitedEl = document.getElementById('visitedTotal');
        // è®€å–ç›®å‰çš„ç¸½æ•¸ï¼Œä¸¦å¢åŠ  1
        visitedEl.textContent = String(parseInt(visitedEl.textContent || '0', 10) + 1); 
        updateActiveMarkersUI();

        showMessage(`âœ… å·²å°‡ã€Œ${store.name}ã€æ¨™è¨˜ç‚ºå·²æ‹œè¨ªä¸¦æ›´æ–° Sheets`, 'success');
      } catch (e) {
        console.error(e);
        // é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
        showMessage(`æ¨™è¨˜å¤±æ•—ï¼š${e.message || e}`, 'error');
      }
    }
    
    // å°‡ removeMarker å‡½å¼æš´éœ²çµ¦ InfoWindow å…§çš„ onclick
    window.removeMarker = removeMarker;


    /**********************
     * æœå°‹ä½ç½® (ä¿æŒä¸è®Š)
     **********************/
    const TAIWAN_LOCATIONS = {
      'å°åŒ—': {lat:25.0330, lng:121.5654}, 'å°åŒ—å¸‚': {lat:25.0330, lng:121.5654},
      'æ–°åŒ—': {lat:25.0150, lng:121.4650}, 'æ–°åŒ—å¸‚': {lat:25.0150, lng:121.4650},
      'æ¡ƒåœ’': {lat:24.9937, lng:121.2973}, 'æ¡ƒåœ’å¸‚': {lat:24.9937, lng:121.2973},
      'å°ä¸­': {lat:24.1477, lng:120.6736}, 'å°ä¸­å¸‚': {lat:24.1477, lng:120.6736},
      'å°å—': {lat:22.9999, lng:120.2269}, 'å°å—å¸‚': {lat:22.9999, lng:120.2269},
      'é«˜é›„': {lat:22.6273, lng:120.3014}, 'é«˜é›„å¸‚': {lat:22.6273, lng:120.3014},
      'å¤§å®‰å€': {lat:25.0267, lng:121.5433}, 'ä¿¡ç¾©å€': {lat:25.0335, lng:121.5645},
    };

    function moveMapToLocation(location, name) {
      if (!map) return showMessage('åœ°åœ–å°šæœªåˆå§‹åŒ–', 'error');
      map.setCenter(location);
      map.setZoom(15);
      const temp = new google.maps.Marker({
        map,
        position: location,
        title: 'æœå°‹çµæœ: ' + name,
        icon: {
          url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
          scaledSize: new google.maps.Size(40, 40)
        }
      });
      setTimeout(() => temp.setMap(null), 5000);
      showMessage(`å·²ç§»å‹•åˆ°: ${name}`, 'success');
    }

    async function searchAndMoveMap() {
      const input = document.getElementById('addressSearch');
      const address = (input.value || '').trim();
      if (!address) return showMessage('è«‹è¼¸å…¥åœ°å€æˆ–å€åŸŸåç¨±', 'error');

      const preset = TAIWAN_LOCATIONS[address] || TAIWAN_LOCATIONS[address+'å¸‚'] || TAIWAN_LOCATIONS[address+'å€'];
      if (preset) return moveMapToLocation(preset, address);

      if (window.google?.maps?.Geocoder) {
        new google.maps.Geocoder().geocode(
          { address: address + ' å°ç£', region: 'TW', language: 'zh-TW' },
          (results, status) => {
            if (status === 'OK' && results[0]) {
              moveMapToLocation({
                lat: results[0].geometry.location.lat(),
                lng: results[0].geometry.location.lng()
              }, results[0].formatted_address);
            } else {
              searchWithNominatim(address);
            }
          }
        );
      } else {
        searchWithNominatim(address);
      }
    }

    async function searchWithNominatim(address) {
      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ' å°ç£')}&limit=1&countrycodes=tw`,
          { headers: {'User-Agent': 'StoreTracker/1.0'} }
        );
        const arr = await res.json();
        if (arr && arr.length) {
          moveMapToLocation(
            {lat: parseFloat(arr[0].lat), lng: parseFloat(arr[0].lon)},
            arr[0].display_name
          );
        } else {
          showMessage('æ‰¾ä¸åˆ°æŒ‡å®šçš„ä½ç½®ï¼Œè«‹è¼¸å…¥æ›´å…·é«”çš„åœ°å€', 'error');
        }
      } catch (e) {
        showMessage('æœå°‹æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨', 'error');
      }
    }

    /**********************
     * UI è¼”åŠ© (ä¿æŒä¸è®Š)
     **********************/
    function showMessage(msg, type='info') {
      const div = document.getElementById('messages');
      const el = document.createElement('div');
      el.className = type;
      el.textContent = msg;
      div.appendChild(el);
      setTimeout(() => el.remove(), 5000);
    }
    
    /**********************
     * Cookie ç¯„ä¾‹ (æ–°å¢ SameSite å±¬æ€§)
     **********************/
    /**
     * è¨­å®š Cookieï¼Œå¼·åˆ¶ä½¿ç”¨ SameSite=Lax (æˆ– Strict)
     * é€™å¯ä»¥é˜²æ­¢ç€è¦½å™¨åœ¨è·¨ç«™è«‹æ±‚ä¸­ç™¼é€æ­¤ Cookieï¼Œå¢å¼· CSRF é˜²ç¦¦ã€‚
     * åƒ…ç”¨æ–¼å‰ç«¯å„²å­˜åå¥½ï¼Œèˆ‡ Apps Script çš„ API è«‹æ±‚ç„¡é—œã€‚
     * @param {string} name Cookie åç¨±
     * @param {string} value Cookie å€¼
     * @param {number} days å„²å­˜å¤©æ•¸
     */
    function setPreferenceCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        // ğŸš¨ é—œéµï¼šåŠ å…¥ SameSite=Lax å±¬æ€§
        document.cookie = name + "=" + (value || "")  + expires + "; path=/; SameSite=Lax"; 
        console.log(`Cookie set: ${name}=${value}; SameSite=Lax`);
    }

    window.addEventListener('load', () => { 
        loadGoogleMapsAPI(); 
        // ç¯„ä¾‹ï¼šæ‡‰ç”¨ç¨‹å¼è¼‰å…¥æ™‚è¨­å®šä¸€å€‹ Cookie
        setPreferenceCookie('map_theme', 'default', 7); 
    });

    /**********************
     * UI è¼”åŠ© (ä¿æŒä¸è®Š)
     **********************/
    function showMessage(msg, type='info') {
      const div = document.getElementById('messages');
      const el = document.createElement('div');
      el.className = type;
      el.textContent = msg;
      div.appendChild(el);
      setTimeout(() => el.remove(), 5000);
    }

    window.addEventListener('load', () => { loadGoogleMapsAPI(); });
  </script>
</body>
</html>
