<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FB JSON è½‰ CSV å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }
        
        .upload-area.dragover {
            background: #e8ebff;
            border-color: #5a67d8;
        }
        
        .upload-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .preview {
            margin-top: 20px;
            max-height: 200px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: #f9f9f9;
            font-size: 13px;
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .options {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .option-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .option-group:last-child {
            border-bottom: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="checkbox"], input[type="radio"] {
            margin-right: 8px;
        }
        
        .encoding-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .radio-label:hover {
            background: #e8ebff;
        }
        
        .radio-label input:checked + span {
            font-weight: bold;
            color: #667eea;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: #1976D2;
            font-size: 16px;
        }
        
        .info-box ul {
            margin-left: 20px;
            font-size: 14px;
            color: #555;
        }
        
        .info-box li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“± FB JSON è½‰ CSV å·¥å…·</h1>
        <p class="subtitle">æ”¯æ´å¤§å‹æª”æ¡ˆãƒ»å®Œå…¨é›¢ç·šãƒ»ä¿®æ­£ Excel äº‚ç¢¼å•é¡Œ</p>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“¤</div>
            <h3>æ‹–æ”¾ JSON æª”æ¡ˆåˆ°é€™è£¡</h3>
            <p>æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
            <input type="file" id="fileInput" accept=".json">
        </div>
        
        <div class="options" id="options" style="display:none;">
            <div class="option-group">
                <label>ğŸ“ é¸æ“‡ç·¨ç¢¼æ ¼å¼ï¼ˆé‡è¦ï¼ï¼‰</label>
                <div class="help-text">âš ï¸ Excel LTSC 2021 å»ºè­°ä½¿ç”¨ã€ŒBig5 (ç¹é«”ä¸­æ–‡)ã€</div>
                <div class="encoding-options">
                    <label class="radio-label">
                        <input type="radio" name="encoding" value="big5" checked>
                        <span>Big5 (ç¹é«”ä¸­æ–‡) - æ¨è–¦ Excel ä½¿ç”¨</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="encoding" value="utf8bom">
                        <span>UTF-8 with BOM</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="encoding" value="utf16">
                        <span>UTF-16 (Unicode)</span>
                    </label>
                </div>
            </div>
            
            <div class="option-group">
                <label>âš™ï¸ è³‡æ–™è™•ç†é¸é …</label>
                <label style="font-weight: normal;">
                    <input type="checkbox" id="includeTimestamp" checked>
                    åŒ…å«æ™‚é–“æˆ³è¨˜
                </label>
                <label style="font-weight: normal;">
                    <input type="checkbox" id="simplifyOutput" checked>
                    ç°¡åŒ–è¼¸å‡ºï¼ˆåƒ…ä¿ç•™ä¸»è¦å…§å®¹ï¼Œå»ºè­°é–‹å•Ÿï¼‰
                </label>
            </div>
            
            <div class="button-group">
                <button class="btn" id="convertBtn" disabled>ğŸ”„ è½‰æ›ç‚º CSV</button>
                <button class="btn btn-success" id="downloadBtn" style="display:none;">ğŸ’¾ ä¸‹è¼‰ CSV</button>
            </div>
        </div>
        
        <div class="info-box" style="display:none;" id="infoBox">
            <h3>ğŸ’¡ å¦‚ä½•åœ¨ Excel ä¸­æ­£ç¢ºé–‹å•Ÿï¼Ÿ</h3>
            <ul id="openInstructions"></ul>
        </div>
        
        <div class="status" id="status"></div>
        <div class="preview" id="preview"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
    <script>
        let jsonData = null;
        let csvContent = null;
        let selectedEncoding = 'big5';

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');
        const options = document.getElementById('options');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const infoBox = document.getElementById('infoBox');
        const openInstructions = document.getElementById('openInstructions');

        // ç›£è½ç·¨ç¢¼é¸æ“‡
        document.querySelectorAll('input[name="encoding"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedEncoding = e.target.value;
                updateInstructions();
            });
        });

        function updateInstructions() {
            let instructions = [];
            if (selectedEncoding === 'big5') {
                instructions = [
                    'ç›´æ¥é›™æ“Š CSV æª”æ¡ˆå³å¯ç”¨ Excel é–‹å•Ÿ',
                    'ä¸­æ–‡æ‡‰è©²æœƒæ­£ç¢ºé¡¯ç¤º',
                    'å¦‚æœé‚„æ˜¯äº‚ç¢¼ï¼Œè«‹é¸æ“‡ UTF-16 ç·¨ç¢¼é‡æ–°è½‰æ›'
                ];
            } else if (selectedEncoding === 'utf16') {
                instructions = [
                    'é–‹å•Ÿ Excel â†’ è³‡æ–™ â†’ å–å¾—è³‡æ–™ â†’ å¾æ–‡å­—/CSV',
                    'é¸æ“‡ä¸‹è¼‰çš„ CSV æª”æ¡ˆ',
                    'åœ¨ã€Œæª”æ¡ˆåŸå§‹æ ¼å¼ã€é¸æ“‡ã€ŒUnicode (UTF-16)ã€',
                    'é»æ“Šã€Œè¼‰å…¥ã€'
                ];
            } else {
                instructions = [
                    'å˜—è©¦ç›´æ¥é›™æ“Šé–‹å•Ÿ',
                    'å¦‚æœäº‚ç¢¼ï¼Œè«‹é¸æ“‡ Big5 ç·¨ç¢¼é‡æ–°è½‰æ›'
                ];
            }
            
            openInstructions.innerHTML = instructions.map(i => `<li>${i}</li>`).join('');
            infoBox.style.display = 'block';
        }

        // æ‹–æ”¾åŠŸèƒ½
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            showStatus('è®€å–æª”æ¡ˆä¸­...', 'info');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let text = e.target.result;
                    
                    // ç¬¬ä¸€æ­¥ï¼šä¿®å¾© Facebook çš„åæ–œç·šå•é¡Œ
                    // å°‡éŒ¯èª¤çš„åæ–œç·šè·³è„«ä¿®æ­£
                    text = fixBackslashes(text);
                    
                    // ç¬¬äºŒæ­¥ï¼šä¿®å¾© Facebook çš„å„ç¨® Unicode ç·¨ç¢¼
                    text = decodeUnicodeEscapes(text);
                    
                    jsonData = JSON.parse(text);
                    showStatus(`âœ… æˆåŠŸè¼‰å…¥ï¼æª”æ¡ˆå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MBï¼Œå…± ${countRecords(jsonData)} ç­†è³‡æ–™`, 'success');
                    options.style.display = 'block';
                    convertBtn.disabled = false;
                    updateInstructions();
                } catch (error) {
                    showStatus('âŒ JSON æ ¼å¼éŒ¯èª¤: ' + error.message + ' - å˜—è©¦ä½¿ç”¨å¯¬é¬†æ¨¡å¼è§£æ...', 'warning');
                    
                    // å˜—è©¦æ›´æ¿€é€²çš„ä¿®å¾©
                    try {
                        text = e.target.result;
                        text = aggressiveFixJSON(text);
                        jsonData = JSON.parse(text);
                        showStatus(`âœ… æˆåŠŸè¼‰å…¥ï¼ˆå¯¬é¬†æ¨¡å¼ï¼‰ï¼æª”æ¡ˆå¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MBï¼Œå…± ${countRecords(jsonData)} ç­†è³‡æ–™`, 'success');
                        options.style.display = 'block';
                        convertBtn.disabled = false;
                        updateInstructions();
                    } catch (error2) {
                        showStatus('âŒ JSON æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æ: ' + error2.message, 'error');
                        console.error('åŸå§‹éŒ¯èª¤:', error);
                        console.error('å¯¬é¬†æ¨¡å¼éŒ¯èª¤:', error2);
                    }
                }
            };
            reader.onerror = () => {
                showStatus('âŒ æª”æ¡ˆè®€å–å¤±æ•—', 'error');
            };
            reader.readAsText(file, 'UTF-8');
        }

        function fixBackslashes(text) {
            // FB JSON ä¸­å¸¸è¦‹çš„å•é¡Œï¼šåœ°å€ç­‰æ–‡å­—ä¸­çš„åæ–œç·šæ²’æœ‰æ­£ç¢ºè·³è„«
            // åœ¨ JSON å­—ä¸²å€¼å…§ï¼Œå–®å€‹åæ–œç·šæ‡‰è©²æ˜¯ \\
            
            // é€™å€‹æ­£å‰‡æœƒæ‰¾å‡ºå­—ä¸²å€¼ä¸­çš„åæ–œç·šï¼Œä¸¦ç¢ºä¿å®ƒå€‘è¢«æ­£ç¢ºè·³è„«
            // ä½†è¦é¿å…å·²ç¶“æ­£ç¢ºè·³è„«çš„æƒ…æ³ï¼ˆå¦‚ \\ \" \n \t \uï¼‰
            
            return text.replace(/"([^"]*?)"/g, (match, content) => {
                // ä¿®å¾©å­—ä¸²å…§å®¹ä¸­çš„åæ–œç·š
                let fixed = content.replace(/\\(?!["\\/bfnrtu])/g, '\\\\');
                return '"' + fixed + '"';
            });
        }

        function aggressiveFixJSON(text) {
            // æ›´æ¿€é€²çš„ JSON ä¿®å¾©ç­–ç•¥
            
            // 1. ä¿®å¾©åæ–œç·š
            text = text.replace(/"([^"]*?)"/g, (match, content) => {
                let fixed = content
                    .replace(/\\/g, '\\\\')  // å…ˆå…¨éƒ¨è·³è„«
                    .replace(/\\\\\\\\/g, '\\\\')  // ä¿®æ­£éåº¦è·³è„«
                    .replace(/\\\\"/g, '\\"')  // ä¿®æ­£å¼•è™Ÿ
                    .replace(/\\\\n/g, '\\n')  // ä¿®æ­£æ›è¡Œ
                    .replace(/\\\\t/g, '\\t')  // ä¿®æ­£tab
                    .replace(/\\\\r/g, '\\r')  // ä¿®æ­£å›è»Š
                    .replace(/\\\\u/g, '\\u'); // ä¿®æ­£unicode
                return '"' + fixed + '"';
            });
            
            // 2. ç§»é™¤ BOM
            text = text.replace(/^\uFEFF/, '');
            
            // 3. ä¿®å¾© Unicode ç·¨ç¢¼
            text = decodeUnicodeEscapes(text);
            
            return text;
        }

        function decodeUnicodeEscapes(text) {
            // è™•ç† \u00xx æ ¼å¼
            text = text.replace(/\\u00([0-9a-f]{2})/gi, (match, hex) => {
                return String.fromCharCode(parseInt(hex, 16));
            });
            
            // è™•ç†å®Œæ•´çš„ \uxxxx æ ¼å¼
            text = text.replace(/\\u([0-9a-f]{4})/gi, (match, hex) => {
                return String.fromCharCode(parseInt(hex, 16));
            });
            
            return text;
        }

        function countRecords(data) {
            if (Array.isArray(data)) return data.length;
            if (data && typeof data === 'object') {
                if (data.posts) return countRecords(data.posts);
                if (data.data) return countRecords(data.data);
                return 1;
            }
            return 0;
        }

        convertBtn.addEventListener('click', convertToCSV);

        function convertToCSV() {
            showStatus('è½‰æ›ä¸­...', 'info');
            
            try {
                const includeTimestamp = document.getElementById('includeTimestamp').checked;
                const simplifyOutput = document.getElementById('simplifyOutput').checked;
                
                let rows = [];
                
                // è™•ç† FB è²¼æ–‡è³‡æ–™
                function processData(data) {
                    if (Array.isArray(data)) {
                        return data.map(item => extractMainData(item));
                    } else if (data && typeof data === 'object') {
                        if (data.posts) return processData(data.posts);
                        if (data.data) return processData(data.data);
                        return [extractMainData(data)];
                    }
                    return [];
                }
                
                function extractMainData(item) {
                    let result = {};
                    
                    // æ™‚é–“æˆ³è¨˜
                    if (includeTimestamp && item.timestamp) {
                        result['æ™‚é–“'] = new Date(item.timestamp * 1000).toLocaleString('zh-TW');
                    }
                    
                    // æ¨™é¡Œ
                    if (item.title) {
                        result['æ¨™é¡Œ'] = cleanText(item.title);
                    }
                    
                    // è²¼æ–‡å…§å®¹ - å¤šå±¤æª¢æŸ¥
                    let postContent = '';
                    if (item.data) {
                        if (Array.isArray(item.data)) {
                            for (let d of item.data) {
                                if (d.post) postContent = d.post;
                                else if (d.text) postContent = d.text;
                                if (postContent) break;
                            }
                        } else if (typeof item.data === 'object') {
                            postContent = item.data.post || item.data.text || '';
                        }
                    }
                    
                    if (!postContent && item.post) postContent = item.post;
                    if (!postContent && item.text) postContent = item.text;
                    
                    if (postContent) {
                        result['å…§å®¹'] = cleanText(postContent);
                    }
                    
                    // é™„ä»¶é€£çµ
                    if (item.attachments) {
                        let links = extractLinks(item.attachments);
                        if (links) result['é€£çµ'] = links;
                    }
                    
                    // å¦‚æœä¸ç°¡åŒ–ï¼ŒåŠ å…¥åŸå§‹è³‡æ–™
                    if (!simplifyOutput) {
                        if (item.data) {
                            result['åŸå§‹è³‡æ–™'] = JSON.stringify(item.data);
                        }
                    }
                    
                    return result;
                }
                
                function cleanText(text) {
                    if (!text) return '';
                    text = String(text);
                    text = decodeUnicodeEscapes(text);
                    // ç§»é™¤å¤šé¤˜ç©ºç™½
                    text = text.replace(/\s+/g, ' ').trim();
                    return text;
                }
                
                function extractLinks(attachments) {
                    if (!attachments) return '';
                    let links = [];
                    
                    function findUrls(obj) {
                        if (Array.isArray(obj)) {
                            obj.forEach(item => findUrls(item));
                        } else if (obj && typeof obj === 'object') {
                            if (obj.url) links.push(obj.url);
                            if (obj.uri) links.push(obj.uri);
                            Object.values(obj).forEach(val => findUrls(val));
                        }
                    }
                    
                    findUrls(attachments);
                    return links.filter(l => l && l !== '').join('; ');
                }
                
                rows = processData(jsonData);
                
                if (rows.length === 0) {
                    showStatus('âŒ æ²’æœ‰æ‰¾åˆ°å¯è½‰æ›çš„è³‡æ–™', 'error');
                    return;
                }
                
                // ç”¢ç”Ÿ CSV
                const headers = Object.keys(rows[0]);
                csvContent = [
                    headers.map(escapeCSV).join(','),
                    ...rows.map(row => 
                        headers.map(header => escapeCSV(row[header] || '')).join(',')
                    )
                ].join('\n');
                
                showStatus(`âœ… è½‰æ›æˆåŠŸï¼å…± ${rows.length} ç­†è³‡æ–™`, 'success');
                
                // é¡¯ç¤ºé è¦½ï¼ˆå‰3è¡Œï¼‰
                const previewLines = csvContent.split('\n').slice(0, 4).join('\n');
                preview.textContent = previewLines + '\n...(åƒ…é¡¯ç¤ºå‰ 3 ç­†)';
                preview.style.display = 'block';
                
                downloadBtn.style.display = 'inline-block';
            } catch (error) {
                showStatus('âŒ è½‰æ›å¤±æ•—: ' + error.message, 'error');
                console.error(error);
            }
        }

        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        downloadBtn.addEventListener('click', () => {
            let blob;
            let filename = 'fb_posts_' + new Date().toISOString().slice(0,10);
            
            if (selectedEncoding === 'big5') {
                // ä½¿ç”¨ encoding.js è½‰æ›ç‚º Big5
                const sjisArray = Encoding.convert(Encoding.stringToCode(csvContent), {
                    to: 'SJIS',
                    from: 'UNICODE'
                });
                const uint8Array = new Uint8Array(sjisArray);
                blob = new Blob([uint8Array], { type: 'text/csv;charset=big5' });
                filename += '_big5.csv';
            } else if (selectedEncoding === 'utf16') {
                // UTF-16 LE with BOM
                const utf16Content = '\ufeff' + csvContent;
                const utf16Array = new Uint16Array(utf16Content.length);
                for (let i = 0; i < utf16Content.length; i++) {
                    utf16Array[i] = utf16Content.charCodeAt(i);
                }
                blob = new Blob([utf16Array], { type: 'text/csv;charset=utf-16le' });
                filename += '_utf16.csv';
            } else {
                // UTF-8 with BOM
                const utf8Content = '\ufeff' + csvContent;
                blob = new Blob([utf8Content], { type: 'text/csv;charset=utf-8' });
                filename += '_utf8.csv';
            }
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            showStatus('âœ… ä¸‹è¼‰å®Œæˆï¼è«‹ç”¨ Excel é–‹å•Ÿæª”æ¡ˆ', 'success');
        });

        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
        }
    </script>
</body>
</html>
