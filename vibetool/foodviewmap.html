<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åº—å®¶æ™¯é»åœ°åœ–è¿½è¹¤å™¨</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang TC","Microsoft JhengHei","Heiti TC",sans-serif;margin:0;background:#f7f9fc;color:#2c3e50}
    .header{padding:28px 20px 16px;text-align:center;background:linear-gradient(135deg,#6a8dff,#7be8cc);color:#fff}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .controls{display:flex;flex-direction:column;gap:12px;margin-bottom:14px}
    #loadData{background:linear-gradient(135deg,#6a8dff,#67d6ff);border:none;color:#fff;font-weight:600;padding:12px 18px;border-radius:10px;cursor:pointer;font-size:16px}
    #loadData:disabled{opacity:.6;cursor:not-allowed}
    .map-container{height:60vh;border-radius:12px;overflow:hidden;background:#eef1f7;box-shadow:0 8px 22px rgba(0,0,0,.06)}
    #map{height:100%;position:relative}
    .loading{display:flex;align-items:center;justify-content:center;height:100%;color:#777}
    .status{margin-top:16px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 8px 22px rgba(0,0,0,.06)}
    .status h3{margin:0 0 8px 0}
    .status-item{display:flex;justify-content:space-between;margin:6px 0;padding:8px 10px;border-radius:8px;background:#f6f8ff}
    #messages .info{background:#eef5ff;border-left:4px solid #3b82f6;margin-top:8px;padding:8px;border-radius:8px}
    #messages .success{background:#edfff5;border-left:4px solid #22c55e;margin-top:8px;padding:8px;border-radius:8px}
    #messages .error{background:#fff2f2;border-left:4px solid #ef4444;margin-top:8px;padding:8px;border-radius:8px}
    .info-window{max-width:280px}
    .info-window h3{margin:0 0 6px}
    .remove-btn{margin-top:8px;background:#22c55e;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    input#addressSearch{flex:1;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:14px}
    .btn-search{background:linear-gradient(135deg,#28a745 0%,#20c997 100%);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ—ºï¸ åº—å®¶æ™¯é»åœ°åœ–è¿½è¹¤å™¨</h1>
    <p>è¼‰å…¥æ‚¨çš„åº—å®¶è³‡æ–™ï¼Œè¿½è¹¤æ‹œè¨ªé€²åº¦</p>
  </div>

  <div class="container">
    <div class="controls">
      <button id="loadData" onclick="loadStoreData()">ğŸ“¥ è¼‰å…¥åº—å®¶è³‡æ–™</button>
      <div style="display:flex;gap:10px;align-items:center">
        <input id="addressSearch" placeholder="è¼¸å…¥åœ°å€æˆ–å€åŸŸåç¨±â€¦" />
        <button class="btn-search" onclick="searchAndMoveMap()">ğŸ” æœå°‹ä½ç½®</button>
      </div>
    </div>

    <div class="map-container">
      <div id="map"><div class="loading"><p>ğŸ“ æ­£åœ¨åˆå§‹åŒ–åœ°åœ–â€¦</p></div></div>
    </div>

    <div class="status">
      <h3>ğŸ“Š ç‹€æ…‹è³‡è¨Š</h3>
      <div class="status-item"><span>ç¸½åº—å®¶æ•¸é‡:</span><span id="totalStores">0</span></div>
      <div class="status-item"><span>å¾…æ‹œè¨ªæ¨™è¨˜:</span><span id="activeMarkers">0</span></div>
      <div class="status-item"><span>å·²æ‹œè¨ªåº—å®¶:</span><span id="visitedTotal">0</span></div>
      <div id="messages"></div>
    </div>
  </div>

  <script>
    /**********************
     *  å¯èª¿åƒæ•¸å€
     **********************/

    // ä½ çš„ Apps Script Web App URLï¼ˆä¸è¦å¸¶ä»»ä½•æŸ¥è©¢åƒæ•¸ï¼‰
    const BASE_API_URL =
      'https://script.google.com/macros/s/AKfycbyXe1tkQjcRMaWE-MqYIQmpzL764lcqKSJXfx96kHNYlLE1MyTVA84WnZHfZ_HRhrfz/exec';

    // Google Maps Keyï¼ˆå¯ç•™ç©ºï¼›è‹¥æœ‰å°±æœƒåŠ  key=ï¼‰
    const GOOGLE_MAPS_KEY = ''; // e.g. 'AIzaSy...'

    // å¯åˆ‡æ›è¦ä¸è¦åªç¹ªè£½æœªæ‹œè¨ªçš„é»ï¼ˆé‚„æ˜¯ä»¥ onlyUnvisited=true ç‚ºä¸»ï¼‰
    const DRAW_ONLY_UNVISITED = true;

    /**********************
     *  å…§éƒ¨è®Šæ•¸
     **********************/
    let map;
    let markers = [];
    let storeData = [];     // ç›®å‰ç•«åœ¨åœ°åœ–ä¸Šçš„åº—å®¶ï¼ˆé€šå¸¸æ˜¯æœªæ‹œè¨ªï¼‰
    let removedStores = new Set(); // æœ¬æ¬¡äº’å‹•ä¸­è¢«æ¨™è¨˜ç‚ºå·²æ‹œè¨ªçš„ index

    // CORS ä»£ç†ï¼ˆå…ˆç›´é€£ï¼Œå¤±æ•—å†ç”¨ä»£ç†ï¼‰
    const CORS_PROXIES = [
      (url)=>fetch(url,{method:'GET',mode:'cors',cache:'no-cache',headers:{'Accept':'application/json, text/plain, */*'}}), // ç›´é€£
      (url)=>fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(url)),
      (url)=>fetch('https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(url)),
      (url)=>fetch('https://cors.isomorphic-git.org/'+url),
    ];

    // API URL å»ºæ§‹å™¨
    const buildUrl = (params = {}) => {
      const usp = new URLSearchParams({...params, _: Date.now()});
      return `${BASE_API_URL}?${usp.toString()}`;
    };

    /**********************
     *  åœ°åœ–åˆå§‹åŒ–
     **********************/
    function initMap() {
      try {
        const defaultCenter = { lat: 25.0330, lng: 121.5654 };
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: defaultCenter,
          mapTypeId: 'roadmap',
          styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
        });
        showMessage('åœ°åœ–åˆå§‹åŒ–å®Œæˆï¼é»æ“Šã€Œè¼‰å…¥åº—å®¶è³‡æ–™ã€é–‹å§‹ä½¿ç”¨','success');
      } catch (err) {
        console.error('åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤:', err);
        showMessage('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API è¨­å®š','error');
      }
    }

    function loadGoogleMapsAPI() {
      const script = document.createElement('script');
      const keyPart = GOOGLE_MAPS_KEY ? `&key=${GOOGLE_MAPS_KEY}` : '';
      script.src = `https://maps.googleapis.com/maps/api/js?v=weekly&callback=initMap${keyPart}`;
      script.async = true;
      script.defer = true;
      script.onerror = () => showMessage('åœ°åœ– API è¼‰å…¥å¤±æ•—','error');
      document.head.appendChild(script);
    }

    /**********************
     *  æŠ“è³‡æ–™ + çµ±è¨ˆ
     **********************/
    async function fetchWithFallback(url) {
      let lastErr;
      for (const invoker of CORS_PROXIES) {
        try {
          const res = await invoker(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res;
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('æ‰€æœ‰é€šé“çš†å¤±æ•—');
    }

    function normalizeRowObject(obj, idxBase=2) {
      // field æ˜ å°„
      const pick = (o, keys)=> keys.find(k => k in o && o[k] !== undefined && o[k] !== null);
      const get = (o, names, d='')=>{
        const k = pick(o, names);
        if (!k) return d;
        return (o[k] ?? d);
      };
      const name   = get(obj, ['é¤å»³æˆ–æ™¯é»','åº—å','åç¨±','name']);
      const cat    = get(obj, ['é¡åˆ¥','åˆ†é¡','category']);
      const focus  = get(obj, ['é—œæ³¨é‡é»','é‡é»','focus']);
      const addr   = get(obj, ['åœ°å€','address']);
      const notes  = get(obj, ['å‚™è¨»','èªªæ˜','description','notes']);
      const lat    = get(obj, ['ç·¯åº¦','lat','latitude']);
      const lng    = get(obj, ['ç¶“åº¦','lng','longitude']);
      const time   = get(obj, ['ç´€éŒ„æ™‚é–“','æ™‚é–“','time']);
      const visit  = get(obj, ['å®Œæˆ','å·²æ‹œè¨ª','completed','visited']);
      const rowIx  = obj.rowIndex || obj.row || obj.rowid || obj._row || null;

      return {
        name, category: cat, focus, address: addr, description: notes,
        lat, lng, recordTime: time, completed: visit, rowIndex: rowIx || idxBase
      };
    }

    function isVisited(store) {
      const v = store.completed ?? store.visited ?? store['å·²æ‹œè¨ª'] ?? store['å®Œæˆ'];
      if (typeof v === 'boolean') return v;
      if (typeof v === 'number')  return v === 1;
      if (typeof v === 'string') {
        const s = v.trim();
        return ['true','TRUE','True','æ˜¯','å·²æ‹œè¨ª','1','âœ“','âœ”'].includes(s);
      }
      return false;
    }

    function parseUnknownResponse(data) {
      // å·²æ˜¯é™£åˆ—ï¼šæ¯ç­†ç•¶æˆç‰©ä»¶ normalize
      if (Array.isArray(data)) {
        return data.map((o, i)=> normalizeRowObject(o, i+2));
      }
      // æœ‰ data: [...]
      if (data && Array.isArray(data.data)) {
        return data.data.map((o, i)=> normalizeRowObject(o, i+2));
      }
      // æœ‰ values: [ [headers...], [...], ... ]
      if (data && Array.isArray(data.values)) {
        const headers = data.values[0].map(h=>String(h).trim());
        return data.values.slice(1).map((row,i)=>{
          const obj = {};
          headers.forEach((h,idx)=> obj[h] = row[idx]);
          obj.rowIndex = i+2;
          return normalizeRowObject(obj, i+2);
        });
      }
      // ç‰©ä»¶ï¼šåŒ…ä¸€å±¤
      if (data && typeof data === 'object') {
        return [ normalizeRowObject(data, 2) ];
      }
      return [];
    }

    async function loadStoreData() {
      const btn = document.getElementById('loadData');
      btn.disabled = true; btn.textContent = 'è¼‰å…¥ä¸­â€¦';
      clearMarkers(); removedStores.clear();
      showMessage('æ­£åœ¨å¾ Google Sheets è¼‰å…¥è³‡æ–™â€¦','info');

      try {
        // 1) å…ˆæŠ“ã€Œè¦ç•«çš„è³‡æ–™ã€ï¼šé€šå¸¸æ˜¯ onlyUnvisited=true
        const listUrl = buildUrl({ onlyUnvisited: DRAW_ONLY_UNVISITED ? 'true' : 'false' });
        const res1 = await fetchWithFallback(listUrl);
        let raw1 = await res1.text();
        try { raw1 = JSON.parse(raw1); } catch {}
        const arr1 = parseUnknownResponse(raw1)
          .filter(s => s.lat && s.lng && s.name);
        // è‹¥å›å‚³ä¹ŸåŒ…å« visited çš„ï¼Œç•«åœ–æ™‚ä»åªç•«æœªæ‹œè¨ª
        storeData = DRAW_ONLY_UNVISITED ? arr1.filter(s => !isVisited(s)) : arr1;

        // 2) å†æŠ“ä¸€æ¬¡å…¨éƒ¨è³‡æ–™ç”¨ä¾†ç®—ç¸½æ•¸ï¼ˆé€™æ¨£ã€Œç¸½åº—å®¶æ•¸é‡ / å·²æ‹œè¨ª / æœªæ‹œè¨ªã€æ‰æœƒæ­£ç¢ºï¼‰
        let totals = { total: 0, visited: 0, unvisited: 0 };
        try {
          const allUrl = buildUrl(); // ä¸å¸¶ onlyUnvisited
          const res2 = await fetchWithFallback(allUrl);
          let raw2 = await res2.text();
          try { raw2 = JSON.parse(raw2); } catch {}
          const all = parseUnknownResponse(raw2);
          totals.total = all.length;
          totals.visited = all.reduce((n, s)=> n + (isVisited(s) ? 1 : 0), 0);
          totals.unvisited = totals.total - totals.visited;
        } catch (e) {
          console.warn('çµ±è¨ˆè£œæŠ“å¤±æ•—ï¼Œæ”¹ç”¨ç•¶å‰è³‡æ–™ä¼°ç®—ï¼š', e);
          totals.total = storeData.length;
          totals.visited = 0;
          totals.unvisited = storeData.length;
        }

        createMarkers();
        applyTotalsToUI(totals);
        showMessage(`æˆåŠŸè¼‰å…¥ ${storeData.length} ç­†ï¼ˆåœ°åœ–ç¹ªè£½ç­†æ•¸ï¼‰`,`success`);
        updateStatsUI(); // è®“ activeMarkers æ­£ç¢º

      } catch (err) {
        console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤:', err);
        showMessage(`è¼‰å…¥å¤±æ•—ï¼š${err.message || err}`,'error');
      } finally {
        btn.disabled = false; btn.textContent = 'ğŸ“¥ è¼‰å…¥åº—å®¶è³‡æ–™';
      }
    }

    function applyTotalsToUI(totals) {
      const totalEl   = document.getElementById('totalStores');
      const visitedEl = document.getElementById('visitedTotal');
      const activeEl  = document.getElementById('activeMarkers');
      totalEl.textContent   = totals.total;
      visitedEl.textContent = totals.visited;
      // activeMarkers äº¤ç”± updateStatsUI() ä»¥ç›®å‰ç•«åœ¨åœ°åœ–ä¸Šçš„ markers ç‚ºæº–
      activeEl.textContent  = markers.length;
    }

    /**********************
     *  ç¹ªè£½ / çµ±è¨ˆ
     **********************/
    function clearMarkers() {
      markers.forEach(m => { try{ m.setMap(null) }catch{}; });
      markers.length = 0;
    }

    function createMarkers() {
      clearMarkers();
      storeData.forEach((store, index) => {
        if (isVisited(store)) return; // ä¿éšªï¼šå³ä½¿åªæŠ“æœªæ‹œè¨ªï¼Œä¹Ÿè·³éå·²æ‹œè¨ª
        const lat = parseFloat(store.lat), lng = parseFloat(store.lng);
        if (Number.isNaN(lat) || Number.isNaN(lng)) return;

        const marker = new google.maps.Marker({
          map, position: {lat, lng},
          title: store.name || 'æœªçŸ¥åº—å®¶',
          icon: { url:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                  scaledSize:new google.maps.Size(40,40) }
        });

        const info = new google.maps.InfoWindow({
          content: `
            <div class="info-window">
              <h3>${store.name || 'æœªçŸ¥åº—å®¶'}</h3>
              <p><strong>é¡åˆ¥:</strong> ${store.category || 'æœªåˆ†é¡'}</p>
              <p><strong>é—œæ³¨é‡é»:</strong> ${store.focus || 'ç„¡'}</p>
              <p><strong>åœ°å€:</strong> ${store.address || 'ç„¡åœ°å€è³‡è¨Š'}</p>
              <p><strong>å‚™è¨»:</strong> ${store.description || 'ç„¡å‚™è¨»'}</p>
              <p><strong>ç´€éŒ„æ™‚é–“:</strong> ${store.recordTime || 'ç„¡ç´€éŒ„'}</p>
              <button class="remove-btn" onclick="removeMarker(${index})">âœ… æ¨™è¨˜ç‚ºå·²æ‹œè¨ª</button>
            </div>`
        });

        marker.addListener('click', () => {
          markers.forEach(m => m.infoWindow?.close());
          info.open(map, marker);
        });

        marker.infoWindow = info;
        marker.storeIndex = index;
        marker.rowIndex   = store.rowIndex;
        markers.push(marker);
      });

      if (markers.length) {
        const bounds = new google.maps.LatLngBounds();
        markers.forEach(m => bounds.extend(m.getPosition()));
        map.fitBounds(bounds);
      }
      updateStatsUI();
    }

    function updateStatsUI() {
      document.getElementById('activeMarkers').textContent = markers.length;
      // è¨»ï¼švisitedTotal ç”± applyTotalsToUI æˆ– mark å¾Œè‡ªèª¿æ•´
    }

    /**********************
     *  æ¨™è¨˜ç‚ºå·²æ‹œè¨ª
     **********************/
    async function markAsVisitedInSheet(rowIndex, storeName) {
      // åªè² è²¬å»º url & ç™¼é€ï¼›ä¸åš UI åˆ¤æ–·çš„é‡è¤‡ if/elseï¼ˆé¿å…ã€Œå°ä¿®æ­£3ã€çš„é‡è¦†å•é¡Œï¼‰
      const url = buildUrl({ action:'markVisited', rowIndex, storeName });
      const res = await fetchWithFallback(url);
      const json = await res.json();
      if (!json || json.success !== true) {
        throw new Error(json?.message || 'æ›´æ–° Google Sheets å¤±æ•—');
      }
      return json;
    }

    async function removeMarker(storeIndex) {
      const marker = markers.find(m => m.storeIndex === storeIndex);
      const store  = storeData[storeIndex];
      if (!marker || !store) { showMessage('æ‰¾ä¸åˆ°è¦ç§»é™¤çš„æ¨™è¨˜','error'); return; }

      try {
        showMessage('æ­£åœ¨æ›´æ–°è³‡æ–™â€¦','info');
        await markAsVisitedInSheet(store.rowIndex, store.name);

        // é—œæ‰ info è¦–çª—èˆ‡åœ°åœ–ç§»é™¤
        marker.infoWindow?.close();
        marker.setMap(null);
        markers = markers.filter(m => m !== marker);

        // ç•¶å‰ session æ¨™è¨˜
        removedStores.add(storeIndex);
        // æœ¬åœ°ä¹Ÿæ¨™æˆå·²æ‹œè¨ªï¼Œä¹‹å¾Œä¸æœƒå†è¢«ç•«å‡º
        storeData[storeIndex].completed = true;

        // è®“ä¸‹æ–¹ã€Œå·²æ‹œè¨ªåº—å®¶ã€æ•¸é‡ +1ï¼ˆç¸½æ•¸ï¼‰
        const visitedEl = document.getElementById('visitedTotal');
        visitedEl.textContent = String(parseInt(visitedEl.textContent||'0',10) + 1);

        updateStatsUI();
        showMessage(`å·²å°‡ã€Œ${store.name}ã€æ¨™è¨˜ç‚ºå·²æ‹œè¨ªä¸¦åŒæ­¥åˆ° Google Sheets`,'success');
      } catch (e) {
        console.error(e);
        showMessage(`æ¨™è¨˜å¤±æ•—ï¼š${e.message || e}`,'error');
      }
    }

    /**********************
     *  æœå°‹ä½ç§»
     **********************/
    const TAIWAN_LOCATIONS = {
      'å°åŒ—':{lat:25.0330,lng:121.5654},'å°åŒ—å¸‚':{lat:25.0330,lng:121.5654},
      'æ–°åŒ—':{lat:25.0150,lng:121.4650},'æ–°åŒ—å¸‚':{lat:25.0150,lng:121.4650},
      'æ¡ƒåœ’':{lat:24.9937,lng:121.2973},'æ¡ƒåœ’å¸‚':{lat:24.9937,lng:121.2973},
      'å°ä¸­':{lat:24.1477,lng:120.6736},'å°ä¸­å¸‚':{lat:24.1477,lng:120.6736},
      'å°å—':{lat:22.9999,lng:120.2269},'å°å—å¸‚':{lat:22.9999,lng:120.2269},
      'é«˜é›„':{lat:22.6273,lng:120.3014},'é«˜é›„å¸‚':{lat:22.6273,lng:120.3014},
      'å¤§å®‰å€':{lat:25.0267,lng:121.5433},'ä¿¡ç¾©å€':{lat:25.0335,lng:121.5645},
    };

    function moveMapToLocation(location, name){
      if(!map) return showMessage('åœ°åœ–å°šæœªåˆå§‹åŒ–','error');
      map.setCenter(location); map.setZoom(15);
      const temp = new google.maps.Marker({
        map, position:location, title:'æœå°‹çµæœ: '+name,
        icon:{url:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',scaledSize:new google.maps.Size(40,40)}
      });
      setTimeout(()=> temp.setMap(null), 5000);
      showMessage(`å·²ç§»å‹•åˆ°: ${name}`,'success');
    }

    async function searchAndMoveMap(){
      const input = document.getElementById('addressSearch');
      const address = (input.value||'').trim();
      if(!address) return showMessage('è«‹è¼¸å…¥åœ°å€æˆ–å€åŸŸåç¨±','error');

      const preset = TAIWAN_LOCATIONS[address] || TAIWAN_LOCATIONS[address+'å¸‚'] || TAIWAN_LOCATIONS[address+'å€'];
      if (preset) return moveMapToLocation(preset, address);

      // æœ‰ Geocoder å°±ç”¨
      if (window.google?.maps?.Geocoder) {
        new google.maps.Geocoder().geocode(
          { address: address+' å°ç£', region:'TW', language:'zh-TW' },
          (results,status)=>{
            if(status==='OK' && results[0]){
              moveMapToLocation({
                lat: results[0].geometry.location.lat(),
                lng: results[0].geometry.location.lng()
              }, results[0].formatted_address);
            } else {
              searchWithNominatim(address);
            }
          }
        );
      } else {
        searchWithNominatim(address);
      }
    }

    async function searchWithNominatim(address){
      try{
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address+' å°ç£')}&limit=1&countrycodes=tw`,
        { headers:{'User-Agent':'StoreTracker/1.0'} });
        const arr = await res.json();
        if(arr && arr.length){
          moveMapToLocation({lat:parseFloat(arr[0].lat),lng:parseFloat(arr[0].lon)}, arr[0].display_name);
        } else {
          showMessage('æ‰¾ä¸åˆ°æŒ‡å®šçš„ä½ç½®ï¼Œè«‹è¼¸å…¥æ›´å…·é«”çš„åœ°å€','error');
        }
      } catch(e){
        showMessage('æœå°‹æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨','error');
      }
    }

    /**********************
     *  UI è¼”åŠ©
     **********************/
    function showMessage(msg,type='info'){
      const div=document.getElementById('messages');
      const el=document.createElement('div');
      el.className=type; el.textContent=msg;
      div.appendChild(el);
      setTimeout(()=> el.remove(), 5000);
    }

    // è¼‰å…¥å¾Œå°±è¼‰å…¥åœ°åœ–
    window.addEventListener('load', ()=>{
      loadGoogleMapsAPI();
    });
  </script>
</body>
</html>
