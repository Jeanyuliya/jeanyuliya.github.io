
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>店家追蹤地圖</title>
  <style>
    /* 統一字體為繁體中文友善字體 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Microsoft JhengHei', 'Inter', Arial, sans-serif; background: #f5f5f5; }
    #map { height: 70vh; width: 100%; border-radius: 8px; overflow: hidden; }
    .controls {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px; /* 統一使用圓角 */
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
      box-shadow: 0 4px #388E3C; /* 添加立體感 */
    }
    button:hover { 
      background: #45a049; 
      transform: translateY(-2px); 
      box-shadow: 0 6px #388E3C; 
    }
    button:active {
      transform: translateY(2px);
      box-shadow: 0 2px #388E3C;
    }
    button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
    #addressSearch {
      flex: 1;
      min-width: 200px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    .stats {
      background: white;
      padding: 15px 20px;
      display: flex;
      gap: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 0 0 8px 8px;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #4CAF50;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    #messages {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }
    #messages > div {
      padding: 15px 20px;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
      /* 確保訊息框在小螢幕下不會溢出 */
      word-wrap: break-word;
    }
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .success { background: #4CAF50; color: white; }
    .error { background: #f44336; color: white; }
    .info { background: #2196F3; color: white; }
    .info-window {
      max-width: 300px;
      padding: 10px;
    }
    .info-window h3 {
      margin-bottom: 10px;
      color: #333;
    }
    .info-window p {
      margin: 5px 0;
      color: #666;
      font-size: 14px;
    }
    .remove-btn {
      width: 100%;
      margin-top: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .remove-btn:hover { background: #45a049; }

    @media (max-width: 600px) {
      .controls { flex-direction: column; align-items: stretch; }
      .stats { gap: 15px; justify-content: space-around; }
      .stat-value { font-size: 24px; }
      #addressSearch { min-width: 100%; }
      button { width: 100%; }
      #messages { right: 10px; left: 10px; top: 10px; max-width: none; }
    }
  </style>
</head>
<body>
  <div class="stats">
    <div class="stat-item">
      <div class="stat-value" id="totalStores">0</div>
      <div class="stat-label">總店家數</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="visitedTotal">0</div>
      <div class="stat-label">已拜訪</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="activeMarkers">0</div>
      <div class="stat-label">待拜訪</div>
    </div>
  </div>

  <div class="controls">
    <button id="loadData" onclick="loadStoreData()">📥 載入店家資料</button>
    <input type="text" id="addressSearch" placeholder="輸入地址或區域名稱（例：台北、大安區）">
    <button onclick="searchAndMoveMap()">🔍 搜尋位置</button>
  </div>

  <div id="map"></div>
  <div id="messages"></div>

  <script>
    /**********************
     * 可調參數區 (請務必在部署後更新這兩個值)
     **********************/

    // 1. 🚨 BASE_API_URL: 單一 Web App URL
    const BASE_API_URL = 'https://script.google.com/macros/s/AKfycbyXe1tkQjcRMaWE-MqYIQmpzL764lcqKSJXfx96kHNYlLE1MyTVA84WnZHfZ_HRhrfz/exec'; 

    // 2. 🚨 PROXY_TOKEN: 呼叫 Geocoding 代理所需的密鑰。
    const PROXY_TOKEN = 'GASsecrettoken4check'; 
    
    // ✅ Google Maps Key（可留空，因為地圖操作不需 Key，Geocoding 透過代理處理）
    const GOOGLE_MAPS_KEY = '';

    // 地圖只畫未拜訪
    const DRAW_ONLY_UNVISITED = true;

    /**********************
     * 內部變數
     **********************/
    let map;
    let markers = [];
    let storeData = [];
    let infoWindow = null; 

    // CORS 方案 (用於 GET 讀取) - 僅在呼叫 Apps Script 失敗時嘗試
    const CORS_INVOCATIONS = [
      (url) => fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(url)),
      (url) => fetch('https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(url)),
      (url) => fetch('https://cors.isomorphic-git.org/' + url),
    ];

    // URL builders
    // Data/Totals GET 請求都帶 action=data
    const DATA_URL = (full = false) => `${BASE_API_URL}?action=data&onlyUnvisited=${full?'false':'true'}&t=${Date.now()}`;
    
    // Geocoding GET 請求帶 action=geocode 和 token 
    const GEOCODE_URL = (address) => 
      `${BASE_API_URL}?action=geocode&address=${encodeURIComponent(address)}&token=${PROXY_TOKEN}&t=${Date.now()}`;


    /**********************
     * 地圖初始化
     **********************/
    function initMap() {
      try {
        const defaultCenter = { lat: 25.0330, lng: 121.5654 };
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12,
          center: defaultCenter,
          mapTypeId: 'roadmap',
          styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
        });
        infoWindow = new google.maps.InfoWindow();
        showMessage('地圖初始化完成！點擊「載入店家資料」開始使用', 'success');
      } catch (err) {
        console.error('地圖初始化錯誤:', err);
        showMessage('地圖載入失敗，請檢查網路或 API 設定', 'error');
      }
    }

    function loadGoogleMapsAPI() {
      const script = document.createElement('script');
      const keyPart = GOOGLE_MAPS_KEY ? `&key=${GOOGLE_MAPS_KEY}` : '';
      script.src = `https://maps.googleapis.com/maps/api/js?v=weekly&callback=initMap${keyPart}`;
      script.async = true;
      script.defer = true;
      script.onerror = () => showMessage('地圖 API 載入失敗', 'error');
      document.head.appendChild(script);
    }

    /**********************
     * 抓資料 + 統計 (GET 讀取)
     **********************/
    async function fetchWithFallback(url) {
      // 嘗試直接讀取
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res;
      } catch (e) {
        // 如果直接讀取失敗，才嘗試 CORS 代理
        console.warn('直接讀取失敗，嘗試 CORS 代理...', e);
        let lastErr;
        for (const call of CORS_INVOCATIONS) {
          try {
            const res = await call(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res;
          } catch (e) {
            lastErr = e;
          }
        }
        throw lastErr || new Error('所有通道皆失敗');
      }
    }

    async function loadStoreData() {
      const btn = document.getElementById('loadData');
      btn.disabled = true;
      btn.textContent = '載入中…';
      clearMarkers();
      showMessage('正在從 Google Sheets 載入資料…', 'info');

      if (BASE_API_URL === 'YOUR_SINGLE_WEBAPP_URL_HERE') {
         showMessage('載入失敗：請設定 index.html 中的 BASE_API_URL', 'error');
         btn.disabled = false;
         btn.textContent = '📥 載入店家資料';
         return;
      }

      try {
        // 呼叫 BASE_API_URL?action=data
        const res1 = await fetchWithFallback(DATA_URL(false)); 
        const text1 = await res1.text();
        const dataResponse = JSON.parse(text1);

        if (!dataResponse.success) {
          throw new Error(dataResponse.message || '資料讀取失敗');
        }
        
        storeData = dataResponse.data.filter(s => s.lat && s.lng && s.name); 
        let totals = dataResponse.meta || { total: storeData.length, visited: 0, unvisited: storeData.length };
        
        createMarkers();
        applyTotalsToUI(totals);
        showMessage(`成功載入 ${storeData.length} 筆待拜訪店家資料 (總計 ${totals.total} 筆)`, 'success');
        updateActiveMarkersUI();

      } catch (err) {
        console.error('載入資料錯誤:', err);
        showMessage(`載入失敗：${err.message || err} (請檢查 GAS 部署權限)`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = '📥 載入店家資料';
      }
    }

    function applyTotalsToUI(totals) {
      document.getElementById('totalStores').textContent = totals.total;
      document.getElementById('visitedTotal').textContent = totals.visited;
      document.getElementById('activeMarkers').textContent = markers.length;
    }

    /**********************
     * 繪製標記 
     **********************/
    function clearMarkers() {
      markers.forEach(m => { try { m.setMap(null) } catch {} });
      markers.length = 0;
    }

    function createMarkers() {
      clearMarkers();
      storeData.forEach((store, index) => {
        if (store.completed) return; 
        
        const lat = parseFloat(store.lat), lng = parseFloat(store.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const marker = new google.maps.Marker({
          map,
          position: {lat, lng},
          title: store.name || '未知店家',
          icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
            scaledSize: new google.maps.Size(40, 40)
          }
        });

        marker.storeData = store;
        marker.storeIndex = index;

        marker.addListener('click', () => {
          if (infoWindow) infoWindow.close(); 
          
          const content = `
            <div class="info-window">
              <h3>${store.name || '未知店家'}</h3>
              <p><strong>類別:</strong> ${store.category || '未分類'}</p>
              <p><strong>關注重點:</strong> ${store.focus || '無'}</p>
              <p><strong>地址:</strong> ${store.address || '無地址資訊'}</p>
              <p><strong>備註:</strong> ${store.description || '無備註'}</p>
              <p><strong>紀錄時間:</strong> ${store.recordTime || '無紀錄'}</p>
              <button class="remove-btn" onclick="removeMarker(${index})">✅ 標記為已拜訪</button>
            </div>`;
            
          infoWindow.setContent(content);
          infoWindow.open(map, marker);
        });

        markers.push(marker);
      });

      if (markers.length) {
        const bounds = new google.maps.LatLngBounds();
        markers.forEach(m => bounds.extend(m.getPosition()));
        map.fitBounds(bounds);
      }
      updateActiveMarkersUI();
    }

    function updateActiveMarkersUI() {
      document.getElementById('activeMarkers').textContent = markers.length;
    }

    /**********************
     * 標記為已拜訪 (POST 寫入)
     **********************/
    async function markAsVisitedInSheet(rowIndex, storeName) {
      const targetUrl = BASE_API_URL;
      
      const payload = {
        action: 'markVisited',
        rowIndex: rowIndex,
        storeName: storeName
      };

      try {
        // 透過 POST 請求，觸發 getnpost.gs 裡的 doPost 函式
        const res = await fetch(targetUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
          throw new Error(`HTTP 錯誤: ${res.status}`);
        }

        const json = await res.json();
        if (!json || json.success !== true) {
          throw new Error(json?.message || json?.error || '更新 Google Sheets 失敗');
        }
        return json;
      } catch (e) {
          throw e;
      }
    }

    async function removeMarker(storeIndex) {
      const marker = markers.find(m => m.storeIndex === storeIndex);
      const store = storeData[storeIndex];
      
      if (!marker || !store) {
        showMessage('找不到要移除的標記', 'error');
        return;
      }
      
      if (infoWindow) infoWindow.close();

      try {
        showMessage(`正在標記「${store.name}」為已完成…`, 'info');
        
        await markAsVisitedInSheet(store.rowIndex, store.name);

        marker.setMap(null);
        markers = markers.filter(m => m !== marker);

        storeData[storeIndex].completed = true;
        
        const visitedEl = document.getElementById('visitedTotal');
        visitedEl.textContent = String(parseInt(visitedEl.textContent || '0', 10) + 1); 
        updateActiveMarkersUI();

        showMessage(`✅ 已將「${store.name}」標記為已拜訪並更新 Sheets`, 'success');
      } catch (e) {
        console.error(e);
        showMessage(`標記失敗：${e.message || e}`, 'error');
      }
    }
    
    window.removeMarker = removeMarker;


    /**********************
     * 搜尋位置 (呼叫單一 Web App 的 Geocoding 代理)
     **********************/
    function moveMapToLocation(location, name) {
      if (!map) return showMessage('地圖尚未初始化', 'error');
      map.setCenter(location);
      map.setZoom(15);
      const temp = new google.maps.Marker({
        map,
        position: location,
        title: '搜尋結果: ' + name,
        icon: {
          url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
          scaledSize: new google.maps.Size(40, 40)
        }
      });
      setTimeout(() => temp.setMap(null), 5000);
      showMessage(`已移動到: ${name}`, 'success');
    }

    async function searchAndMoveMap() {
      const input = document.getElementById('addressSearch');
      const address = (input.value || '').trim();
      if (!address) return showMessage('請輸入地址或區域名稱', 'error');

      const btn = document.querySelector('.controls button[onclick="searchAndMoveMap()"]');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '搜尋中...';

      if (BASE_API_URL === 'YOUR_SINGLE_WEBAPP_URL_HERE' || PROXY_TOKEN === 'YOUR_SECRET_PROXY_TOKEN_HERE') {
         showMessage('Geocoding 搜尋失敗：請設定 BASE_API_URL 和 PROXY_TOKEN', 'error');
         btn.disabled = false;
         btn.textContent = originalText;
         return;
      }
      
      showMessage(`正在透過 Apps Script 代理搜尋「${address}」...`, 'info');

      try {
        // 呼叫 BASE_API_URL?action=geocode&token=...
        const geocodeUrl = GEOCODE_URL(address);
        
        const res = await fetch(geocodeUrl);
        
        if (!res.ok) {
          throw new Error(`HTTP 錯誤: ${res.status}`);
        }
        
        const json = await res.json();

        if (!json.success) {
            // 處理 Geocoding 代理服務回傳的錯誤 (例如 Unauthorized 或 API 錯誤)
            throw new Error(json.message || 'Geocoding 代理服務失敗');
        }

        // Geocoding 結果在 json.data 陣列中
        const results = json.data;
        const status = json.meta.status;

        if (status !== 'OK' || !results || results.length === 0) {
             throw new Error(`Google Geocoding 服務錯誤或找不到結果。狀態: ${status || '未知'}`);
        }

        const location = results[0].geometry.location;
        const formattedAddress = results[0].formatted_address;

        moveMapToLocation(location, formattedAddress);
        
      } catch (e) {
        console.error('Geocoding 錯誤:', e);
        showMessage(`搜尋失敗：${e.message || e}。請檢查 GAS 中的 PW_TOKEN 和 API_KEY 配置。`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    /**********************
     * UI 輔助
     **********************/
    function showMessage(msg, type='info') {
      const div = document.getElementById('messages');
      const el = document.createElement('div');
      el.className = type;
      el.textContent = msg;
      div.appendChild(el);
      setTimeout(() => el.remove(), 5000);
    }
    
    window.addEventListener('load', () => { 
        loadGoogleMapsAPI(); 
    });
  </script>
</body>
</html>
