<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FB JSON 轉 CSV 工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }
        
        .upload-area.dragover {
            background: #e8ebff;
            border-color: #5a67d8;
        }
        
        .upload-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .preview {
            margin-top: 20px;
            max-height: 200px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: #f9f9f9;
            font-size: 13px;
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .options {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }
        
        .option-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .option-group:last-child {
            border-bottom: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="checkbox"], input[type="radio"] {
            margin-right: 8px;
        }
        
        .encoding-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .radio-label:hover {
            background: #e8ebff;
        }
        
        .radio-label input:checked + span {
            font-weight: bold;
            color: #667eea;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: #1976D2;
            font-size: 16px;
        }
        
        .info-box ul {
            margin-left: 20px;
            font-size: 14px;
            color: #555;
        }
        
        .info-box li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📱 FB JSON 轉 CSV 工具</h1>
        <p class="subtitle">支援大型檔案・完全離線・修正 Excel 亂碼問題</p>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📤</div>
            <h3>拖放 JSON 檔案到這裡</h3>
            <p>或點擊選擇檔案</p>
            <input type="file" id="fileInput" accept=".json">
        </div>
        
        <div class="options" id="options" style="display:none;">
            <div class="option-group">
                <label>📝 選擇編碼格式（重要！）</label>
                <div class="help-text">⚠️ Excel LTSC 2021 建議使用「Big5 (繁體中文)」</div>
                <div class="encoding-options">
                    <label class="radio-label">
                        <input type="radio" name="encoding" value="big5" checked>
                        <span>Big5 (繁體中文) - 推薦 Excel 使用</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="encoding" value="utf8bom">
                        <span>UTF-8 with BOM</span>
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="encoding" value="utf16">
                        <span>UTF-16 (Unicode)</span>
                    </label>
                </div>
            </div>
            
            <div class="option-group">
                <label>⚙️ 資料處理選項</label>
                <label style="font-weight: normal;">
                    <input type="checkbox" id="includeTimestamp" checked>
                    包含時間戳記
                </label>
                <label style="font-weight: normal;">
                    <input type="checkbox" id="simplifyOutput" checked>
                    簡化輸出（僅保留主要內容，建議開啟）
                </label>
            </div>
            
            <div class="button-group">
                <button class="btn" id="convertBtn" disabled>🔄 轉換為 CSV</button>
                <button class="btn btn-success" id="downloadBtn" style="display:none;">💾 下載 CSV</button>
            </div>
        </div>
        
        <div class="info-box" style="display:none;" id="infoBox">
            <h3>💡 如何在 Excel 中正確開啟？</h3>
            <ul id="openInstructions"></ul>
        </div>
        
        <div class="status" id="status"></div>
        <div class="preview" id="preview"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
    <script>
        let jsonData = null;
        let csvContent = null;
        let selectedEncoding = 'big5';

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const preview = document.getElementById('preview');
        const options = document.getElementById('options');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const infoBox = document.getElementById('infoBox');
        const openInstructions = document.getElementById('openInstructions');

        // 監聽編碼選擇
        document.querySelectorAll('input[name="encoding"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedEncoding = e.target.value;
                updateInstructions();
            });
        });

        function updateInstructions() {
            let instructions = [];
            if (selectedEncoding === 'big5') {
                instructions = [
                    '直接雙擊 CSV 檔案即可用 Excel 開啟',
                    '中文應該會正確顯示',
                    '如果還是亂碼，請選擇 UTF-16 編碼重新轉換'
                ];
            } else if (selectedEncoding === 'utf16') {
                instructions = [
                    '開啟 Excel → 資料 → 取得資料 → 從文字/CSV',
                    '選擇下載的 CSV 檔案',
                    '在「檔案原始格式」選擇「Unicode (UTF-16)」',
                    '點擊「載入」'
                ];
            } else {
                instructions = [
                    '嘗試直接雙擊開啟',
                    '如果亂碼，請選擇 Big5 編碼重新轉換'
                ];
            }
            
            openInstructions.innerHTML = instructions.map(i => `<li>${i}</li>`).join('');
            infoBox.style.display = 'block';
        }

        // 拖放功能
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            showStatus('讀取檔案中...', 'info');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    let text = e.target.result;
                    
                    // 第一步：修復 Facebook 的反斜線問題
                    // 將錯誤的反斜線跳脫修正
                    text = fixBackslashes(text);
                    
                    // 第二步：修復 Facebook 的各種 Unicode 編碼
                    text = decodeUnicodeEscapes(text);
                    
                    jsonData = JSON.parse(text);
                    showStatus(`✅ 成功載入！檔案大小: ${(file.size / 1024 / 1024).toFixed(2)} MB，共 ${countRecords(jsonData)} 筆資料`, 'success');
                    options.style.display = 'block';
                    convertBtn.disabled = false;
                    updateInstructions();
                } catch (error) {
                    showStatus('❌ JSON 格式錯誤: ' + error.message + ' - 嘗試使用寬鬆模式解析...', 'warning');
                    
                    // 嘗試更激進的修復
                    try {
                        text = e.target.result;
                        text = aggressiveFixJSON(text);
                        jsonData = JSON.parse(text);
                        showStatus(`✅ 成功載入（寬鬆模式）！檔案大小: ${(file.size / 1024 / 1024).toFixed(2)} MB，共 ${countRecords(jsonData)} 筆資料`, 'success');
                        options.style.display = 'block';
                        convertBtn.disabled = false;
                        updateInstructions();
                    } catch (error2) {
                        showStatus('❌ JSON 格式錯誤，無法解析: ' + error2.message, 'error');
                        console.error('原始錯誤:', error);
                        console.error('寬鬆模式錯誤:', error2);
                    }
                }
            };
            reader.onerror = () => {
                showStatus('❌ 檔案讀取失敗', 'error');
            };
            reader.readAsText(file, 'UTF-8');
        }

        function fixBackslashes(text) {
            // FB JSON 中常見的問題：地址等文字中的反斜線沒有正確跳脫
            // 在 JSON 字串值內，單個反斜線應該是 \\
            
            // 這個正則會找出字串值中的反斜線，並確保它們被正確跳脫
            // 但要避免已經正確跳脫的情況（如 \\ \" \n \t \u）
            
            return text.replace(/"([^"]*?)"/g, (match, content) => {
                // 修復字串內容中的反斜線
                let fixed = content.replace(/\\(?!["\\/bfnrtu])/g, '\\\\');
                return '"' + fixed + '"';
            });
        }

        function aggressiveFixJSON(text) {
            // 更激進的 JSON 修復策略
            
            // 1. 修復反斜線
            text = text.replace(/"([^"]*?)"/g, (match, content) => {
                let fixed = content
                    .replace(/\\/g, '\\\\')  // 先全部跳脫
                    .replace(/\\\\\\\\/g, '\\\\')  // 修正過度跳脫
                    .replace(/\\\\"/g, '\\"')  // 修正引號
                    .replace(/\\\\n/g, '\\n')  // 修正換行
                    .replace(/\\\\t/g, '\\t')  // 修正tab
                    .replace(/\\\\r/g, '\\r')  // 修正回車
                    .replace(/\\\\u/g, '\\u'); // 修正unicode
                return '"' + fixed + '"';
            });
            
            // 2. 移除 BOM
            text = text.replace(/^\uFEFF/, '');
            
            // 3. 修復 Unicode 編碼
            text = decodeUnicodeEscapes(text);
            
            return text;
        }

        function decodeUnicodeEscapes(text) {
            // 處理 \u00xx 格式
            text = text.replace(/\\u00([0-9a-f]{2})/gi, (match, hex) => {
                return String.fromCharCode(parseInt(hex, 16));
            });
            
            // 處理完整的 \uxxxx 格式
            text = text.replace(/\\u([0-9a-f]{4})/gi, (match, hex) => {
                return String.fromCharCode(parseInt(hex, 16));
            });
            
            return text;
        }

        function countRecords(data) {
            if (Array.isArray(data)) return data.length;
            if (data && typeof data === 'object') {
                if (data.posts) return countRecords(data.posts);
                if (data.data) return countRecords(data.data);
                return 1;
            }
            return 0;
        }

        convertBtn.addEventListener('click', convertToCSV);

        function convertToCSV() {
            showStatus('轉換中...', 'info');
            
            try {
                const includeTimestamp = document.getElementById('includeTimestamp').checked;
                const simplifyOutput = document.getElementById('simplifyOutput').checked;
                
                let rows = [];
                
                // 處理 FB 貼文資料
                function processData(data) {
                    if (Array.isArray(data)) {
                        return data.map(item => extractMainData(item));
                    } else if (data && typeof data === 'object') {
                        if (data.posts) return processData(data.posts);
                        if (data.data) return processData(data.data);
                        return [extractMainData(data)];
                    }
                    return [];
                }
                
                function extractMainData(item) {
                    let result = {};
                    
                    // 時間戳記
                    if (includeTimestamp && item.timestamp) {
                        result['時間'] = new Date(item.timestamp * 1000).toLocaleString('zh-TW');
                    }
                    
                    // 標題
                    if (item.title) {
                        result['標題'] = cleanText(item.title);
                    }
                    
                    // 貼文內容 - 多層檢查
                    let postContent = '';
                    if (item.data) {
                        if (Array.isArray(item.data)) {
                            for (let d of item.data) {
                                if (d.post) postContent = d.post;
                                else if (d.text) postContent = d.text;
                                if (postContent) break;
                            }
                        } else if (typeof item.data === 'object') {
                            postContent = item.data.post || item.data.text || '';
                        }
                    }
                    
                    if (!postContent && item.post) postContent = item.post;
                    if (!postContent && item.text) postContent = item.text;
                    
                    if (postContent) {
                        result['內容'] = cleanText(postContent);
                    }
                    
                    // 附件連結
                    if (item.attachments) {
                        let links = extractLinks(item.attachments);
                        if (links) result['連結'] = links;
                    }
                    
                    // 如果不簡化，加入原始資料
                    if (!simplifyOutput) {
                        if (item.data) {
                            result['原始資料'] = JSON.stringify(item.data);
                        }
                    }
                    
                    return result;
                }
                
                function cleanText(text) {
                    if (!text) return '';
                    text = String(text);
                    text = decodeUnicodeEscapes(text);
                    // 移除多餘空白
                    text = text.replace(/\s+/g, ' ').trim();
                    return text;
                }
                
                function extractLinks(attachments) {
                    if (!attachments) return '';
                    let links = [];
                    
                    function findUrls(obj) {
                        if (Array.isArray(obj)) {
                            obj.forEach(item => findUrls(item));
                        } else if (obj && typeof obj === 'object') {
                            if (obj.url) links.push(obj.url);
                            if (obj.uri) links.push(obj.uri);
                            Object.values(obj).forEach(val => findUrls(val));
                        }
                    }
                    
                    findUrls(attachments);
                    return links.filter(l => l && l !== '').join('; ');
                }
                
                rows = processData(jsonData);
                
                if (rows.length === 0) {
                    showStatus('❌ 沒有找到可轉換的資料', 'error');
                    return;
                }
                
                // 產生 CSV
                const headers = Object.keys(rows[0]);
                csvContent = [
                    headers.map(escapeCSV).join(','),
                    ...rows.map(row => 
                        headers.map(header => escapeCSV(row[header] || '')).join(',')
                    )
                ].join('\n');
                
                showStatus(`✅ 轉換成功！共 ${rows.length} 筆資料`, 'success');
                
                // 顯示預覽（前3行）
                const previewLines = csvContent.split('\n').slice(0, 4).join('\n');
                preview.textContent = previewLines + '\n...(僅顯示前 3 筆)';
                preview.style.display = 'block';
                
                downloadBtn.style.display = 'inline-block';
            } catch (error) {
                showStatus('❌ 轉換失敗: ' + error.message, 'error');
                console.error(error);
            }
        }

        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        downloadBtn.addEventListener('click', () => {
            let blob;
            let filename = 'fb_posts_' + new Date().toISOString().slice(0,10);
            
            if (selectedEncoding === 'big5') {
                // 使用 encoding.js 轉換為 Big5
                const sjisArray = Encoding.convert(Encoding.stringToCode(csvContent), {
                    to: 'SJIS',
                    from: 'UNICODE'
                });
                const uint8Array = new Uint8Array(sjisArray);
                blob = new Blob([uint8Array], { type: 'text/csv;charset=big5' });
                filename += '_big5.csv';
            } else if (selectedEncoding === 'utf16') {
                // UTF-16 LE with BOM
                const utf16Content = '\ufeff' + csvContent;
                const utf16Array = new Uint16Array(utf16Content.length);
                for (let i = 0; i < utf16Content.length; i++) {
                    utf16Array[i] = utf16Content.charCodeAt(i);
                }
                blob = new Blob([utf16Array], { type: 'text/csv;charset=utf-16le' });
                filename += '_utf16.csv';
            } else {
                // UTF-8 with BOM
                const utf8Content = '\ufeff' + csvContent;
                blob = new Blob([utf8Content], { type: 'text/csv;charset=utf-8' });
                filename += '_utf8.csv';
            }
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            showStatus('✅ 下載完成！請用 Excel 開啟檔案', 'success');
        });

        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
        }
    </script>
</body>
</html>
