<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>店家追蹤地圖</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Microsoft JhengHei',Arial,sans-serif;background:#f5f5f5;}
    #map{height:70vh;width:100%;}
    .controls{background:white;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);
      display:flex;gap:15px;align-items:center;flex-wrap:wrap;}
    button{background:#4CAF50;color:white;border:none;padding:12px 24px;border-radius:5px;
      cursor:pointer;font-size:16px;transition:all 0.3s;}
    button:hover{background:#45a049;transform:translateY(-2px);}
    button:disabled{background:#ccc;cursor:not-allowed;}
    #addressSearch{flex:1;min-width:200px;padding:12px;border:2px solid #ddd;border-radius:5px;font-size:16px;}
    .stats{background:white;padding:15px 20px;display:flex;gap:30px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    .stat-item{display:flex;flex-direction:column;align-items:center;}
    .stat-value{font-size:32px;font-weight:bold;color:#4CAF50;}
    .stat-label{font-size:14px;color:#666;margin-top:5px;}
    #messages{position:fixed;top:20px;right:20px;z-index:1000;max-width:400px;}
    #messages>div{padding:15px 20px;margin-bottom:10px;border-radius:5px;
      box-shadow:0 2px 10px rgba(0,0,0,0.2);animation:slideIn 0.3s ease;}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
    .success{background:#4CAF50;color:white;}
    .error{background:#f44336;color:white;}
    .info{background:#2196F3;color:white;}
    .info-window{max-width:300px;padding:10px;}
    .info-window h3{margin-bottom:10px;color:#333;}
    .info-window p{margin:5px 0;color:#666;font-size:14px;}
    .remove-btn{width:100%;margin-top:10px;background:#4CAF50;color:white;border:none;
      padding:10px;border-radius:5px;cursor:pointer;font-size:14px;}
    .remove-btn:hover{background:#45a049;}
  </style>
</head>
<body>
  <div class="stats">
    <div class="stat-item"><div class="stat-value" id="totalStores">0</div><div class="stat-label">總店家數</div></div>
    <div class="stat-item"><div class="stat-value" id="visitedTotal">0</div><div class="stat-label">已拜訪</div></div>
    <div class="stat-item"><div class="stat-value" id="activeMarkers">0</div><div class="stat-label">待拜訪</div></div>
  </div>

  <div class="controls">
    <button id="loadData" onclick="loadStoreData()">📥 載入店家資料</button>
    <input type="text" id="addressSearch" placeholder="輸入地址或區域名稱（例：台北、大安區）" />
    <button onclick="searchAndMoveMap()">🔍 搜尋位置</button>
  </div>

  <div id="map"></div>
  <div id="messages"></div>

  <script>
    /**********************
     *  可調參數區
     **********************/
    const BASE_API_URL = 'https://script.google.com/macros/s/AKfycbyXe1tkQjcRMaWE-MqYIQmpzL764lcqKSJXfx96kHNYlLE1MyTVA84WnZHfZ_HRhrfz/exec';
    const APP_VERSION = '1.0.0';   // 握手參數
    const SHARED_KEY = 'frontend-v3.1';   // （公開salt）
    const DRAW_ONLY_UNVISITED = true;

    let map, markers = [], storeData = [];

    /**********************
     *  產生簽章
     **********************/
    async function makeSignature(ts, secret) {
      const enc = new TextEncoder();
      const key = await crypto.subtle.importKey("raw", enc.encode(secret),
        {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
      const sig = await crypto.subtle.sign("HMAC", key, enc.encode(String(ts)));
      return btoa(String.fromCharCode(...new Uint8Array(sig)))
        .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }

    /**********************
     *  CORS 代理容錯
     **********************/
    async function fetchWithFallback(url) {
      const proxies = [
        (u)=>fetch(u),
        (u)=>fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(u)),
        (u)=>fetch('https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(u))
      ];
      for(const fn of proxies){
        try{
          const res=await fn(url);
          if(res.ok)return res;
        }catch(e){}
      }
      throw new Error('所有通道皆失敗');
    }

    /**********************
     *  從 GAS 取 Maps Key（經代理）
     **********************/
    async function getMapApiKey() {
      const url = `${BASE_API_URL}?action=getMapKey&appVersion=${APP_VERSION}`;
      const res = await fetchWithFallback(url);
      const json = await res.json();
      if(!json.success||!json.apiKey) throw new Error(json.message||'無法取得 Maps Key');
      return json.apiKey;
    }

    /**********************
     *  載入 Google Maps
     **********************/
    async function loadGoogleMapsAPI() {
      try{
        const key = await getMapApiKey();
        const script=document.createElement('script');
        script.src=`https://maps.googleapis.com/maps/api/js?key=${key}&callback=initMap&v=weekly`;
        script.async=true;script.defer=true;
        script.onerror=()=>showMessage('地圖 API 載入失敗','error');
        document.head.appendChild(script);
      }catch(e){
        console.error('Maps Key 取得失敗:',e);
        showMessage('無法從伺服端取得 Maps Key','error');
      }
    }

    /**********************
     *  API URL 生成
     **********************/
    const DATA_URL = () => `${BASE_API_URL}?onlyUnvisited=${DRAW_ONLY_UNVISITED?'true':'false'}&appVersion=${APP_VERSION}`;
    async function UPDATE_URL(rowIndex,storeName){
      const ts=Date.now(),sig=await makeSignature(ts,SHARED_KEY);
      return `${BASE_API_URL}?action=markVisited&rowIndex=${rowIndex}&storeName=${encodeURIComponent(storeName)}&ts=${ts}&sig=${sig}&appVersion=${APP_VERSION}`;
    }

    /**********************
     *  主要資料流程
     **********************/
    async function loadStoreData(){
      const btn=document.getElementById('loadData');
      btn.disabled=true;btn.textContent='載入中…';
      showMessage('從 Google Sheets 載入資料中…','info');
      try{
        const res=await fetchWithFallback(DATA_URL());
        const json=await res.json();
        if(!json.success) throw new Error(json.message||'資料載入失敗');
        storeData=json.data||[];
        createMarkers();
        const meta=json.meta||{};
        document.getElementById('totalStores').textContent=meta.total||storeData.length;
        document.getElementById('visitedTotal').textContent=meta.visited||0;
        document.getElementById('activeMarkers').textContent=meta.unvisited||storeData.length;
        showMessage(`成功載入 ${storeData.length} 筆資料`,'success');
      }catch(e){
        showMessage(e.message||'載入失敗','error');
      }finally{
        btn.disabled=false;btn.textContent='📥 載入店家資料';
      }
    }

    /**********************
     *  地圖與標記
     **********************/
    function initMap(){
      const c={lat:25.0330,lng:121.5654};
      map=new google.maps.Map(document.getElementById('map'),{zoom:12,center:c});
      showMessage('地圖初始化完成','success');
    }

    function createMarkers(){
      markers.forEach(m=>m.setMap(null));markers=[];
      storeData.forEach((s,i)=>{
        if(s.completed)return;
        const lat=parseFloat(s.lat),lng=parseFloat(s.lng);
        if(!lat||!lng)return;
        const marker=new google.maps.Marker({
          map,position:{lat,lng},title:s.name||'未知店家',
          icon:{url:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',scaledSize:new google.maps.Size(40,40)}
        });
        const info=new google.maps.InfoWindow({
          content:`<div class="info-window">
            <h3>${s.name||'未知店家'}</h3>
            <p><strong>地址:</strong>${s.address||'無'}</p>
            <p><strong>備註:</strong>${s.description||'無'}</p>
            <button class="remove-btn" onclick="removeMarker(${i})">✅ 標記為已拜訪</button>
          </div>`
        });
        marker.addListener('click',()=>{markers.forEach(m=>m.infoWindow?.close());info.open(map,marker);});
        marker.infoWindow=info;marker.storeIndex=i;marker.rowIndex=s.rowIndex;
        markers.push(marker);
      });
      document.getElementById('activeMarkers').textContent=markers.length;
    }

    async function removeMarker(idx){
      const m=markers.find(x=>x.storeIndex===idx);
      const s=storeData[idx];
      if(!m||!s)return showMessage('找不到標記','error');
      try{
        showMessage('更新中…','info');
        const url=await UPDATE_URL(s.rowIndex,s.name);
        const res=await fetchWithFallback(url);
        const j=await res.json();
        if(!j.success)throw new Error(j.message);
        m.setMap(null);
        document.getElementById('visitedTotal').textContent=parseInt(document.getElementById('visitedTotal').textContent)+1;
        document.getElementById('activeMarkers').textContent=parseInt(document.getElementById('activeMarkers').textContent)-1;
        showMessage(`「${s.name}」已標記為已拜訪`,'success');
      }catch(e){showMessage(`標記失敗：${e.message}`,'error');}
    }

    /**********************
     *  搜尋地點
     **********************/
    async function searchAndMoveMap(){
      const q=document.getElementById('addressSearch').value.trim();
      if(!q)return showMessage('請輸入地點','error');
      const g=new google.maps.Geocoder();
      g.geocode({address:q+' 台灣',region:'TW'},(r,s)=>{
        if(s==='OK'&&r[0]){
          const loc=r[0].geometry.location;
          map.setCenter(loc);map.setZoom(15);
          new google.maps.Marker({map,position:loc,icon:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'});
          showMessage(`移動到 ${r[0].formatted_address}`,'success');
        }else showMessage('找不到指定地點','error');
      });
    }

    /**********************
     *  UI
     **********************/
    function showMessage(msg,type='info'){
      const box=document.getElementById('messages');
      const el=document.createElement('div');
      el.className=type;el.textContent=msg;
      box.appendChild(el);
      setTimeout(()=>el.remove(),5000);
    }

    window.addEventListener('load',()=>{loadGoogleMapsAPI();});
  </script>
</body>
</html>
